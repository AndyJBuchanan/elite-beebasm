\************************************************
\* ELITE<A>
\************************************************

LOMEM=&3D70
C_A%=&F40
W%=&7200
L%=&1128
HIMEM=W%
\Z=0
D%=&563A
WP=&D40
K%=&900
LS%=WP-1
QQ18=&400
T%=&300

NOST=18
NOSH=12
COPS=2
SH3=COPS
CYL=7
THG=6
SST=8
MSL=9
AST=10
OIL=11
TGL=12
ESC=13
NI%=36
POW=15
B=&30
FF=&FF

OSWRCH=&FFEE
OSBYTE=&FFF4
OSWORD=&FFF1
OSFILE=&FFDD
SCLI=&FFF7
VIA=&FE40
USVIA=VIA
IRQ1V=&204
VSCAN=57

XX21=D%
ZP=0
X=128
Y=96

\\ ZERO PAGE
org ZP
.RAND   skip 4  ;=FNZT(4)
.TRTB%  skip 2  ;	skip 2	;=FNZ2
.T1	skip 1	;=FNZ
.SC	skip 2	;=FNZ2
SCH=SC+1
.XX16   skip 18 ;=FNZT(18)
.P      skip 3  ;=FNZT(3)
.XX0	skip 2	;=FNZ2
.INF	skip 2	;=FNZ2
.V	skip 2	;=FNZ2
.XX	skip 2	;=FNZ2
.YY	skip 2	;=FNZ2
.SUNX	skip 2	;=FNZ2
.BETA	skip 1	;=FNZ
.BET1	skip 1	;=FNZ
.XC	skip 1	;=FNZ
.YC	skip 1	;=FNZ
.QQ22	skip 2	;=FNZ2
.ECMA	skip 1	;=FNZ
.XX15   skip 6  ;=FNZT(6)
.XX12   skip 6  ;=FNZT(6)

X1=XX15
Y1=X1+1
X2=Y1+1
Y2=X2+1

.K      skip 4  ;=FNZT(4)
.KL     skip 16 ;=FNZT(16)
.LAS	skip 1	;=FNZ
.MSTG	skip 1	;=FNZ

f0=&20
f1=&71
f2=&72
f3=&73
f4=&14
f5=&74
f6=&75
f7=&16
f8=&76
f9=&77
KY1=KL+1
KY2=KL+2
KY3=KL+3
KY4=KL+4
KY5=KL+5
KY6=KL+6
KY7=KL+7
KY12=KL+8
KY13=KL+9
KY14=KL+10
KY15=KL+11
KY16=KL+12
KY17=KL+13
KY18=KL+14
KY19=KL+15

.INWK   skip NI%  ;=FNZT(NI%)
XX19=INWK+33
XX1=INWK
.LSP	skip 1	;=FNZ
.QQ15   skip 6  ;=FNZT(6)
.XX18   skip 9  ;=FNZT(9)
QQ17=XX18
QQ19=QQ17+1
K5=XX18
K6=K5+4
.ALP1	skip 1	;=FNZ
.ALP2	skip 2	;=FNZ2
.BET2	skip 2	;=FNZ2
.DELTA	skip 1	;=FNZ
.DELT4	skip 2	;=FNZ2
.U	skip 1	;=FNZ
.Q	skip 1	;=FNZ
.R	skip 1	;=FNZ
.S	skip 1	;=FNZ
.XSAV	skip 1	;=FNZ
.YSAV	skip 1	;=FNZ
.XX17	skip 1	;=FNZ
.QQ11	skip 1	;=FNZ
.ZZ	skip 1	;=FNZ
.XX13	skip 1	;=FNZ
.MCNT	skip 1	;=FNZ
.DL	skip 1	;=FNZ
.TYPE	skip 1	;=FNZ
.JSTX	skip 1	;=FNZ
.JSTY	skip 1	;=FNZ
.ALPHA	skip 1	;=FNZ
.QQ12	skip 1	;=FNZ
.TGT	skip 1	;=FNZ
.SWAP	skip 1	;=FNZ
.COL	skip 1	;=FNZ
.FLAG	skip 1	;=FNZ
.CNT	skip 1	;=FNZ
.CNT2	skip 1	;=FNZ
.STP	skip 1	;=FNZ
.XX4	skip 1	;=FNZ
.XX20	skip 1	;=FNZ
.XX14	skip 1	;=FNZ
.RAT	skip 1	;=FNZ
.RAT2	skip 1	;=FNZ
.K2     skip 4  ;=FNZT(4)

;IFZ=4THENZ=6ELSEZ=4

\\ WORKSPACE at WP=&D40
org WP
.FRIN   skip NOSH+1 ;=FNWT(NOSH+1)
.MANY   skip 14 ;=FNWT(14)
SSPR=MANY+SST
.ECMP   skip 1  ;=FNW
.MJ   skip 1  ;=FNW
CABTMP=MANY
.LAS2   skip 1  ;=FNW
.MSAR   skip 1  ;=FNW
.VIEW   skip 1  ;=FNW
.LASCT   skip 1 ;=FNW
.GNTMP   skip 1 ;=FNW
.HFX   skip 1  ;=FNW
.EV   skip 1  ;=FNW
.DLY   skip 1  ;=FNW
.de   skip 1  ;=FNW
T=&D1
XX2=&D2
K3=XX2
K4=K3+14

.LSO    skip 192    ;=FNWT(192)
LSX=LSO
.LSX2   skip 78 ;=FNWT(78)
.LSY2   skip 78 ;=FNWT(78)
.SY     skip NOST+1 ;=FNWT(NOST+1)
.SYL    skip NOST+1 ;=FNWT(NOST+1)
.SZ     skip NOST+1 ;=FNWT(NOST+1)
.SZL    skip NOST+1 ;=FNWT(NOST+1)

.XSAV2  skip 1;=FNW
.YSAV2  skip 1;=FNW

.MCH    skip 1  ;=FNWFNW

.FSH skip 1  ;=FNW
.ASH	skip 1	;=FNW
.ENERGY	skip 1	;=FNW
\\REMFF
.LASX	skip 1	;=FNW
.LASY	skip 1	;=FNW
.COMX	skip 1	;=FNW
.COMY	skip 1	;=FNW
.QQ24	skip 1	;=FNW
.QQ25	skip 1	;=FNW
.QQ28	skip 1	;=FNW
.QQ29	skip 1	;=FNW
.gov	skip 1	;=FNW
.tek	skip 1	;=FNW
.SLSP    skip 2  ;=FNW2
.XX24	skip 1	;=FNW
.ALTIT	skip 1	;=FNW
VEC=&7FFE
svn=&7FFD

.QQ2 skip 6  ;=FNWT(6)
.QQ3	skip 1	;=FNW
.QQ4	skip 1	;=FNW
.QQ5	skip 1	;=FNW
.QQ6 skip 2  ;=FNW2
.QQ7 skip 2  ;=FNW2
.QQ8 skip 2  ;=FNW2
.QQ9	skip 1	;=FNW
.QQ10	skip 1	;=FNW
.NOSTM	skip 1	;=FNW

\\ WORKSPACE at T%=&300
ORG T%
.TP	skip 1	;=FNTP
.QQ0	skip 1	;=FNTP
.QQ1	skip 1	;=FNTP
.QQ21   skip 6  ;=FNTPT(6)
.CASH   skip 4  ;=FNTPT(4)
.QQ14	skip 1	;=FNTP
.COK	skip 1	;=FNTP
.GCNT	skip 1	;=FNTP
.LASER  skip 6  ;=FNTPT(6)
.CRGO	skip 1	;=FNTP
.QQ20   skip 17 ;=FNTPT(17)
.ECM	skip 1	;=FNTP
.BST	skip 1	;=FNTP
.BOMB	skip 1	;=FNTP
.ENGY	skip 1	;=FNTP
.DKCMP	skip 1	;=FNTP
.GHYP	skip 1	;=FNTP
.ESCP   skip 5  ;=FNTPT(5)
.NOMSL	skip 1	;=FNTP
.FIST	skip 1	;=FNTP
.AVL    skip 17 ;=FNTPT(17)
.QQ26	skip 1	;=FNTP
.TALLY  skip 2  ;=FNTPT(2)
.SVC    skip 3  ;=FNTPT(3)

NT%=SVC+2-TP    ;NT%=SVC+2-TP

SX=P%   ; T%
SXL=SX+NOST+1
XX3=256
\\REM&70

\ ZP allocations
\DEFFNZ=FNZT(1)
\DEFFNZ2=FNZT(2)
\DEFFNZT(N%)
\ZP=ZP+N%
\=ZP-N%

\ WP allocations
\DEFFNW=FNWT(1)
\DEFFNW2=FNWT(2)
\DEFFNWT(N%)
\WP=WP+N%
\=WP-N%

\ T% allocations
\DEFFNTP=FNTPT(1)
\DEFFNTPT(N%)
\T%=T%+N%
\=T%-N%


;P%=C%
;O%=W%
ORG C_A%
H_A%=L%           ;+P%-C% as P%=C% above

\[OPTZ

.S%
EQUW TT170
EQUW TT26
EQUW IRQ1
EQUW BR1

.COMC brk
.DNOIZ brk
.DAMP brk
.DJD brk
.PATG brk
.FLH brk
.JSTGY brk
.JSTE brk
.JSTK brk

.M% LDAK%
STARAND

LDXJSTX
JSRcntr
JSRcntr
TXA
EOR#128
TAY
AND#128
STAALP2
STXJSTX
EOR#128
STAALP2+1
TYA
BPLP%+7
EOR#FF
CLC
ADC#1
LSRA
LSRA
CMP#8
BCSP%+4
LSRA
CLC
STAALP1
ORAALP2
STAALPHA

LDXJSTY
JSRcntr
TXA
EOR#128
TAY
AND#128
STXJSTY
STABET2+1
EOR#128
STABET2
TYA
BPLP%+4
EOR#FF
ADC#4
LSRA
LSRA
LSRA
LSRA
CMP#3
BCSP%+3
LSRA
STABET1
ORABET2
STABETA

LDAKY2
BEQMA17
LDADELTA
CMP#40
BCSMA17
INCDELTA
.MA17 LDAKY1
BEQMA4
DECDELTA
BNEMA4
INCDELTA
.MA4

LDAKY15
ANDNOMSL
BEQMA20
LDY#&EE
JSRABORT
LDA#40
JSRNOISE
.MA31 LDA#0
STAMSAR
.MA20 LDAMSTG
BPLMA25
LDAKY14
BEQMA25
LDXNOMSL
BEQMA25
STAMSAR
LDY#&E0
JSRMSBAR
.MA25

LDAKY16
BEQMA24
LDAMSTG
BMIMA64
JSRFRMIS
.MA24 LDAKY12
BEQMA76
ASLBOMB
.MA76

LDAKY13
ANDESCP
BEQP%+5
JMPESCAPE
LDAKY18
BEQP%+5
JSRWARP
LDAKY17
ANDECM
BEQMA64
LDAECMA
BNEMA64
DECECMP
JSRECBLB2
.MA64

LDAKY19
ANDDKCMP
ANDSSPR
BEQMA68
LDAK%+NI%+32
BMIMA68
JMPGOIN
.MA68

LDA#0
STALAS
STADELT4
LDADELTA
LSRA
RORDELT4
LSRA
RORDELT4
STADELT4+1

LDALASCT
BNEMA3
LDAKY7
BEQMA3
LDAGNTMP
CMP#242
BCSMA3
LDXVIEW
LDALASER,X
BEQMA3
PHA
AND#127
STALAS
STALAS2
LDA#0
JSRNOISE
JSRLASLI
PLA
BPLma1
LDA#0
.ma1 AND#&FA
STALASCT
.MA3

LDX#0
.MAL1

STXXSAV
LDAFRIN,X
BNEP%+5
JMPMA18
STATYPE
JSRGINF

LDY#(NI%-1)
.MAL2 LDA(INF),Y
STAINWK,Y
DEY
BPLMAL2
LDATYPE
BMIMA21
ASLA
TAY
LDAXX21-2,Y
STAXX0
LDAXX21-1,Y
STAXX0+1

LDABOMB
BPLMA21
CPY#2*SST
BEQMA21
LDAINWK+31
AND#32
BNEMA21
LDAINWK+31
ORA#128
STAINWK+31
JSREXNO2

.MA21 JSRMVEIT
LDY#(NI%-1)
.MAL3 LDAINWK,Y
STA(INF),Y
DEY
BPLMAL3

LDAINWK+31
AND#&A0
JSRMAS4
BNEMA65
LDAINWK
ORAINWK+3
ORAINWK+6
BMIMA65
LDXTYPE
BMIMA65
CPX#SST
BEQISDK
AND#&C0
BNEMA65
CPX#MSL
BEQMA65

CPX#OIL
BCSP%+5
JMPMA58
LDABST
ANDINWK+5
BPLMA58
LDA#3
CPX#TGL
BCCoily
BNEslvy2
LDA#16
BNEslvy2

.oily JSRDORND
AND#7
.slvy2 STAQQ29
LDA#1
JSRtnpr
LDY#78
BCSMA59
LDYQQ29
ADCQQ20,Y
STAQQ20,Y
TYA
ADC#208
JSRMESS

JMPMA60
.MA65 JMPMA26

.ISDK LDAK%+NI%+32
BMIMA62
LDAINWK+14
CMP#&D6
BCCMA62
JSRSPS4
LDAXX15+2
BMIMA62
CMP#89
BCCMA62
LDAINWK+16
AND#&7F
CMP#80
BCCMA62
.GOIN LDA#0
STAQQ22+1
LDA#8
JSRLAUN
JSRRES4
JMPBAY
.MA62 LDADELTA
CMP#5
BCCMA67
JMPDEATH

.MA59 JSREXNO3
.MA60 ASLINWK+31
SEC
RORINWK+31
.MA61 BNEMA26

.MA67 LDA#1
STADELTA
LDA#5
BNEMA63
.MA58 ASLINWK+31
SEC
RORINWK+31
LDAINWK+35
SEC
RORA
.MA63 JSROOPS
JSREXNO3
.MA26

LDAQQ11
BNEMA15
JSRPLUT

JSRHITCH
BCCMA8
LDAMSAR
BEQMA47
JSRBEEP
LDXXSAV
LDY#&E
JSRABORT2
.MA47 LDALAS
BEQMA8
LDX#15
JSREXNO
LDAINWK+35
SEC
SBCLAS
BCSMA14

LDATYPE
CMP#SST
BEQMA14+2
LDAINWK+31
ORA#128
STAINWK+31
BCSMA8
JSRDORND
BPLoh
LDY#0
AND(XX0),Y
STACNT
.um BEQoh
LDX#OIL
LDA#0
JSRSFS1
DECCNT
BPLum
.oh JSREXNO2

.MA14 STAINWK+35
LDATYPE
JSRANGRY
.MA8

JSRLL9
.MA15 LDY#35
LDAINWK+35
STA(INF),Y

LDAINWK+31
BPLMAC1
AND#&20
BEQNBOUN
LDATYPE
CMP#COPS
BNEq2
LDAFIST
ORA#64
STAFIST
.q2 LDADLY
ORAMJ
BNEKS1S
LDY#10
LDA(XX0),Y
BEQKS1S
TAX
INY
LDA(XX0),Y
TAY
JSRMCASH
LDA#0
JSRMESS
.KS1S JMPKS1
.NBOUN

.MAC1 LDATYPE
BMIMA27
JSRFAROF
BCCKS1S
.MA27 LDY#31
LDAINWK+31
STA(INF),Y
LDXXSAV
INX
JMPMAL1
.MA18 LDABOMB
BPLMA77
ASLBOMB
JSRWSCAN
LDA#&30
STA&FE21
.MA77

LDAMCNT
AND#7
BNEMA22
LDXENERGY
BPLb
LDXASH
JSRSHD
STXASH
LDXFSH
JSRSHD
STXFSH
.b SEC
LDAENGY
ADCENERGY
BCSP%+5
STAENERGY

LDAMJ
BNEMA23S
LDAMCNT
AND#31
BNEMA93
LDASSPR
BNEMA23S
TAY
JSRMAS2
BNEMA23S

LDX#28
.MAL4 LDAK%,X
STAINWK,X
DEX
BPLMAL4
INX
LDY#9
JSRMAS1
BNEMA23S
LDX#3
LDY#11
JSRMAS1
BNEMA23S
LDX#6
LDY#13
JSRMAS1
BNEMA23S

LDA#&C0
JSRFAROF2
BCCMA23S

LDAQQ11
BNEP%+5\!
JSRWPLS
JSRNWSPS
.MA23S JMPMA23

.MA22 LDAMJ
BNEMA23
LDAMCNT
AND#31
.MA93 CMP#10
BNEMA29
LDA#50
CMPENERGY
BCCP%+6
ASLA
JSRMESS
LDY#FF
STYALTIT
INY
JSRm
BNEMA23
JSRMAS3
BCSMA23
SBC#&24
BCCMA28
STAR
JSRLL5
LDAQ
STAALTIT
BNEMA23
.MA28 JMPDEATH

.MA29 CMP#20
BNEMA23
LDA#30
STACABTMP
LDASSPR
BNEMA23
LDY#NI%
JSRMAS2
BNEMA23
JSRMAS3
EOR#FF
ADC#30
STACABTMP
BCSMA28

CMP#&E0
BCCMA23
LDABST
BEQMA23
LDADELT4+1
LSRA
ADCQQ14
CMP#70
BCCP%+4
LDA#70
STAQQ14
LDA#160
JSRMESS

.MA23 LDALAS2
BEQMA16
LDALASCT
CMP#8
BCSMA16
JSRLASLI2
LDA#0
STALAS2
.MA16

LDAECMP
BEQMA69
JSRDENGY
BEQMA70
.MA69 LDAECMA
BEQMA66
DECECMA
BNEMA66
.MA70 JSRECMOF
.MA66

LDAQQ11
BNEMA9
JMPSTARS

.MAS1 LDAINWK,Y
ASLA
STAK+1
LDAINWK+1,Y
ROLA
STAK+2
LDA#0
RORA
STAK+3
JSRMVT3
STAINWK+2,X
LDYK+1
STYINWK,X
LDYK+2
STYINWK+1,X
AND#127
.MA9 RTS
.m LDA#0
.MAS2 ORAK%+2,Y
ORAK%+5,Y
ORAK%+8,Y
AND#127
RTS

.MAS3 LDAK%+1,Y
JSRSQUA2
STAR
LDAK%+4,Y
JSRSQUA2
ADCR
BCSMA30
STAR
LDAK%+7,Y
JSRSQUA2
ADCR
BCCP%+4
.MA30 LDA#FF
RTS

.MVEIT LDAINWK+31
AND#&A0
BNEMV30

LDAMCNT
EORXSAV
AND#15
BNEMV3
JSRTIDY
.MV3 LDXTYPE
BPLP%+5
JMPMV40
LDAINWK+32
BPLMV30
CPX#MSL
BEQMV26

LDAMCNT
EORXSAV
AND#7
BNEMV30
.MV26 JSRTACTICS
.MV30 JSRSCAN

LDAINWK+27
ASLA
ASLA
STAQ
LDAINWK+10
AND#127
JSRFMLTU
STAR
LDAINWK+10
LDX#0
JSRMVT1-2

LDAINWK+12
AND#127
JSRFMLTU
STAR
LDAINWK+12
LDX#3
JSRMVT1-2
LDAINWK+14
AND#127
JSRFMLTU
STAR
LDAINWK+14
LDX#6
JSRMVT1-2

LDAINWK+27
CLC
ADCINWK+28
BPLP%+4
LDA#0
LDY#15
CMP(XX0),Y
BCCP%+4
LDA(XX0),Y
STAINWK+27

LDA#0
STAINWK+28

LDXALP1
LDAINWK
EOR#FF
STAP
LDAINWK+1
JSRMLTU2-2
STAP+2
LDAALP2+1
EORINWK+2
LDX#3
JSRMVT6

STAK2+3
LDAP+1
STAK2+1
EOR#FF
STAP
LDAP+2
STAK2+2\K2=Y-aX

LDXBET1
JSRMLTU2-2
STAP+2
LDAK2+3
EORBET2
LDX#6
JSRMVT6
STAINWK+8
LDAP+1
STAINWK+6
EOR#FF
STAP
LDAP+2
STAINWK+7\Z=Z+bK2

JSRMLTU2
STAP+2
LDAK2+3
STAINWK+5
EORBET2
EORINWK+8
BPLMV43
LDAP+1
ADCK2+1
STAINWK+3
LDAP+2
ADCK2+2
STAINWK+4
JMPMV44
.MV43

LDAK2+1
SBCP+1
STAINWK+3
LDAK2+2
SBCP+2
STAINWK+4
BCSMV44
LDA#1
SBCINWK+3
STAINWK+3
LDA#0
SBCINWK+4
STAINWK+4
LDAINWK+5
EOR#128
STAINWK+5

.MV44\Y=K2-bZ
LDXALP1
LDAINWK+3
EOR#FF
STAP
LDAINWK+4
JSRMLTU2-2
STAP+2
LDAALP2
EORINWK+5
LDX#0
JSRMVT6
STAINWK+2
LDAP+2
STAINWK+1
LDAP+1
STAINWK\X=X+aY

.MV45 LDADELTA
STAR
LDA#128
LDX#6
JSRMVT1
LDATYPE
AND#&81
CMP#&81
BNEP%+3
RTS \Z=Z-d

LDY#9
JSRMVS4
LDY#15
JSRMVS4
LDY#21
JSRMVS4
LDAINWK+30
AND#128
STARAT2
LDAINWK+30
AND#127
BEQMV8
CMP#127
SBC#0
ORARAT2
STAINWK+30

LDX#15
LDY#9
JSRMVS5
LDX#17
LDY#11
JSRMVS5
LDX#19
LDY#13
JSRMVS5

.MV8 LDAINWK+29
AND#128
STARAT2
LDAINWK+29
AND#127
BEQMV5
CMP#127
SBC#0
ORARAT2
STAINWK+29

LDX#15
LDY#21
JSRMVS5
LDX#17
LDY#23
JSRMVS5
LDX#19
LDY#25
JSRMVS5

.MV5 LDAINWK+31
AND#&A0
BNEMVD1
LDAINWK+31
ORA#16
STAINWK+31
JMPSCAN
.MVD1 LDAINWK+31
AND#&EF
STAINWK+31
RTS

AND#128
.MVT1 ASLA
STAS
LDA#0
RORA
STAT
LSRS
EORINWK+2,X
BMIMV10
LDAR
ADCINWK,X
STAINWK,X
LDAS
ADCINWK+1,X
STAINWK+1,X
LDAINWK+2,X
ADC#0
ORAT
STAINWK+2,X
RTS

.MV10 LDAINWK,X
SEC
SBCR
STAINWK,X
LDAINWK+1,X
SBCS
STAINWK+1,X
LDAINWK+2,X
AND#127
SBC#0
ORA#128
EORT
STAINWK+2,X
BCSMV11

LDA#1
SBCINWK,X
STAINWK,X
LDA#0
SBCINWK+1,X
STAINWK+1,X
LDA#0
SBCINWK+2,X
AND#127
ORAT
STAINWK+2,X
.MV11 RTS

.MVT3 LDAK+3
STAS
AND#128
STAT
EORINWK+2,X
BMIMV13
LDAK+1
CLC
ADCINWK,X
STAK+1
LDAK+2
ADCINWK+1,X
STAK+2
LDAK+3
ADCINWK+2,X
AND#127
ORAT
STAK+3
RTS

.MV13 LDAS
AND#127
STAS
LDAINWK,X
SEC
SBCK+1
STAK+1
LDAINWK+1,X
SBCK+2
STAK+2
LDAINWK+2,X
AND#127
SBCS
ORA#128
EORT
STAK+3
BCSMV14

LDA#1
SBCK+1
STAK+1
LDA#0
SBCK+2
STAK+2
LDA#0
SBCK+3
AND#127
ORAT
STAK+3
.MV14 RTS

.MVS4 LDAALPHA
STAQ
LDXINWK+2,Y
STXR
LDXINWK+3,Y
STXS
LDXINWK,Y
STXP
LDAINWK+1,Y
EOR#128
JSRMAD
STAINWK+3,Y
STXINWK+2,Y
STXP \Y=Y-aX

LDXINWK,Y
STXR
LDXINWK+1,Y
STXS
LDAINWK+3,Y
JSRMAD
STAINWK+1,Y
STXINWK,Y
STXP \X=X+aY

LDABETA
STAQ
LDXINWK+2,Y
STXR
LDXINWK+3,Y
STXS
LDXINWK+4,Y
STXP
LDAINWK+5,Y
EOR#128
JSRMAD
STAINWK+3,Y
STXINWK+2,Y
STXP\Y=Y-bZ

LDXINWK+4,Y
STXR
LDXINWK+5,Y
STXS
LDAINWK+3,Y
JSRMAD
STAINWK+5,Y
STXINWK+4,Y
RTS\Z=Z+bY

.MVS5 LDAINWK+1,X
AND#127
LSRA
STAT
LDAINWK,X
SEC
SBCT
STAR
LDAINWK+1,X
SBC#0
STAS
LDAINWK,Y
STAP
LDAINWK+1,Y
AND#128
STAT
LDAINWK+1,Y
AND#127
LSRA
RORP
LSRA
RORP
LSRA
RORP
LSRA
RORP
ORAT
EORRAT2
STXQ
JSRADD
STAK+1
STXK

LDXQ
LDAINWK+1,Y
AND#127
LSRA
STAT
LDAINWK,Y
SEC
SBCT
STAR
LDAINWK+1,Y
SBC#0
STAS
LDAINWK,X
STAP
LDAINWK+1,X
AND#128
STAT
LDAINWK+1,X
AND#127
LSRA
RORP
LSRA
RORP
LSRA
RORP
LSRA
RORP
ORAT
EOR#128
EORRAT2

STXQ
JSRADD
STAINWK+1,Y
STXINWK,Y
LDXQ
LDAK
STAINWK,X
LDAK+1
STAINWK+1,X
RTS

.MVT6 TAY
EORINWK+2,X
BMIMV50
LDAP+1
CLC
ADCINWK,X
STAP+1
LDAP+2
ADCINWK+1,X
STAP+2
TYA
RTS

.MV50 LDAINWK,X
SEC
SBCP+1
STAP+1
LDAINWK+1,X
SBCP+2
STAP+2
BCCMV51
TYA
EOR#128
RTS
.MV51 LDA#1
SBCP+1
STAP+1
LDA#0
SBCP+2
STAP+2
TYA
RTS

.MV40 LDAALPHA
EOR#128
STAQ
LDAINWK
STAP
LDAINWK+1
STAP+1
LDAINWK+2
JSRMULT3
LDX#3
JSRMVT3\K=Y-aX

LDAK+1
STAK2+1
STAP
LDAK+2
STAK2+2
STAP+1
LDABETA
STAQ
LDAK+3
STAK2+3
JSRMULT3
LDX#6
JSRMVT3
LDAK+1
STAP
STAINWK+6
LDAK+2
STAP+1
STAINWK+7
LDAK+3
STAINWK+8\Z=Z+bK2

EOR#128
JSRMULT3
LDAK+3
AND#128
STAT
EORK2+3
BMIMV1

LDAK
\CLC
ADCK2
LDAK+1
ADCK2+1
STAINWK+3
LDAK+2
ADCK2+2
STAINWK+4
LDAK+3
ADCK2+3
JMPMV2

.MV1 LDAK
SEC
SBCK2
LDAK+1
SBCK2+1
STAINWK+3
LDAK+2
SBCK2+2
STAINWK+4
LDAK2+3
AND#127
STAP
LDAK+3
AND#127
SBCP
STAP
BCSMV2

LDA#1
SBCINWK+3
STAINWK+3
LDA#0
SBCINWK+4
STAINWK+4
LDA#0
SBCP
ORA#128
.MV2 EORT
STAINWK+5\Y=K2-bZ

LDAALPHA
STAQ
LDAINWK+3
STAP
LDAINWK+4
STAP+1
LDAINWK+5
JSRMULT3
LDX#0
JSRMVT3
LDAK+1
STAINWK
LDAK+2
STAINWK+1
LDAK+3
STAINWK+2\X=X+aY

JMPMV45
\\]

;IFZ>4OSCLI"S.ELTA "+STR$~W%+" "+STR$~O%+" "+STR$~L%+" "+STR$~H%
;PRINT "S.ELTA ",~W%," ",~O%," ",~L%," ",~H%

PRINT "ELITE<A>"
PRINT "ASSEMBLE AT W%=", ~C_A%
PRINT "P%=",~P%
PRINT "CODE SIZE=", ~(P%-C_A%)
PRINT "EXECUTE AT L%=", ~L%
PRINT "RELOAD AT H%=", ~H_A%

PRINT "S.ELTA ",~C_A%," ",~P%," ",~L%," ",~H_A%
SAVE "output/ELTA.bin", C_A%, P%, L%
PRINT "A d,";

\************************************************
\* ELITE<B>
\************************************************

;O%=W%
C_B%=P%
H_B%=L%+P%-C_A%
Q%=FALSE
J%=P%

\[OPTZ

.NA% EQUS "JAMESON"
EQUB13
EQUB0

EQUB20\QQ0
EQUB173\QQ1
EQUD&2485A4A\QQ21
EQUW&B753 \Base seed
;EQUD(((&E8030000)AND(NOTQ%))+((&CA9A3B)ANDQ%))\CASH,&80969800
IF Q%
EQUD &CA9A3B
ELSE
EQUD &E8030000
ENDIF
EQUB70 ;fuel
EQUB 0 ;COK-UP
EQUB0 ;GALACTIC COUNT
EQUB POW+(128ANDQ%)
EQUB (POW+128)ANDQ%
EQUB0
EQUB0
EQUW0 ;LASER
EQUB 22+(15ANDQ%) \37 CRGO
EQUD0
EQUD0
EQUD0
EQUD0
EQUB0\crgo
EQUB Q% ;ECM
EQUB Q% ;BST
EQUB Q%AND127 ;BOMB
EQUB Q%AND1 ;ENGY++
EQUB Q% ;DCK COMP
EQUB Q% ;GHYP
EQUB Q% ;ESCP
EQUD FALSE ;EXPAND
EQUB 3+(Q%AND1) ;MISSILES
EQUB FALSE ;FIST
EQUB16
EQUB15
EQUB17
EQUB0
EQUB3
EQUB28
EQUB14
EQUW0
EQUB10
EQUB0
EQUB17
EQUB58
EQUB7
EQUB9
EQUB8
EQUB0
EQUB 0 ;QQ26
EQUW 0 ;TALLY
EQUB 128 ;SVC

PRINT "NT%=", ~NT%
PRINT "J%=", ~J%

IF 0        ; CHECKSUM PERFORMED IN BCFS.PY SCRIPT
CH%=NT%-2
CY%=0
FORI%,CH%+J%,1+J%,-1
CH%=CH%+CY%+(I%?7)
CY%=(CH%>255)AND1
CH%=CH%MOD256
CH%=CH%EOR(I%?8)
NEXT
ELSE
CH%=&92     ; HARDCODED CHECKSUM FOR BUILD
ENDIF

.CHK2 EQUB CH% EOR&A9
.CHK EQUB CH%

.UNIV
FORI%,0,12
;!O%=K%+I%*NI%
;O%=O%+2
;P%=P%+2
EQUW K%+I%*NI%
NEXT

.TWOS EQUD&10204080
EQUD&01020408
.TWOS2 EQUD&183060C0
EQUD&0303060C
.CTWOS EQUD&11224488
EQUB&88

.LL30
.LOIN STYYSAV

LDA#128
STAS
ASLA
STASWAP
LDAX2
SBCX1
BCSLI1
EOR#FF
ADC#1
SEC
.LI1 STAP

LDAY2
SBCY1
BCSLI2
EOR#FF
ADC#1
.LI2 STAQ
CMPP
BCCSTPX
JMPSTPY

.STPX LDXX1
CPXX2
BCCLI3
DECSWAP
LDAX2
STAX1
STXX2
TAX
LDAY2
LDYY1
STAY1
STYY2
.LI3

LDAY1
LSRA
LSRA
LSRA
ORA#&60
STASCH
LDAY1
AND#7
TAY
TXA
AND#&F8
STASC

TXA
AND#7
TAX
LDATWOS,X
STAR

LDAQ
LDX#254
STXQ
.LIL1 ASLA
BCSLI4
CMPP
BCCLI5
.LI4 SBCP
SEC
.LI5 ROLQ
BCSLIL1

LDXP
INX
LDAY2
SBCY1
BCSDOWN

LDASWAP
BNELI6
DEX
.LIL2 LDAR
EOR(SC),Y
STA(SC),Y

.LI6 LSRR
BCCLI7
RORR
LDASC
ADC#8
STASC

.LI7 LDAS
ADCQ
STAS
BCCLIC2
DEY
BPLLIC2
DECSCH
LDY#7

.LIC2 DEX
BNELIL2
LDYYSAV
RTS

.DOWN LDASWAP
BEQLI9
DEX
.LIL3 LDAR
EOR(SC),Y
STA(SC),Y

.LI9 LSRR
BCCLI10
RORR
LDASC
ADC#8
STASC

.LI10 LDAS
ADCQ
STAS
BCCLIC3
INY
CPY#8
BNELIC3
INCSCH
LDY#0

.LIC3 DEX
BNELIL3
LDYYSAV
RTS

.STPY LDYY1
TYA
LDXX1
CPYY2
BCSLI15
DECSWAP
LDAX2
STAX1
STXX2
TAX
LDAY2
STAY1
STYY2
TAY

.LI15 LSRA
LSRA
LSRA
ORA#&60
STASCH
TXA
AND#&F8
STASC

TXA
AND#7
TAX
LDATWOS,X
STAR
LDAY1
AND#7
TAY

LDAP
LDX#1
STXP
.LIL4 ASLA
BCSLI13
CMPQ
BCCLI14
.LI13 SBCQ
SEC
.LI14 ROLP
BCCLIL4
LDXQ
INX
LDAX2
SBCX1
BCCLFT

CLC
LDASWAP
BEQLI17
DEX
.LIL5 LDAR
EOR(SC),Y
STA(SC),Y
.LI17 DEY
BPLLI16
DECSCH
LDY#7

.LI16 LDAS
ADCP
STAS
BCCLIC5
LSRR
BCCLIC5
RORR
LDASC
ADC#8
STASC

.LIC5 DEX
BNELIL5
LDYYSAV
RTS

.LFT LDASWAP
BEQLI18
DEX
.LIL6 LDAR
EOR(SC),Y
STA(SC),Y
.LI18 DEY
BPLLI19
DECSCH
LDY#7
.LI19 LDAS
ADCP
STAS
BCCLIC6

ASLR
BCCLIC6
ROLR
LDASC
SBC#7
STASC
CLC
.LIC6 DEX
BNELIL6
LDYYSAV

.HL6 RTS

.NLIN3 JSRTT27
.NLIN4 LDA#19
BNENLIN2
.NLIN LDA#23
INCYC
.NLIN2 STAY1
LDX#2
STXX1
LDX#254
STXX2
BNEHLOIN

.HLOIN2 JSREDGES
STYY1
LDA#0
STALSO,Y

.HLOIN STYYSAV
LDXX1
CPXX2
BEQHL6
BCCHL5
LDAX2
STAX1
STXX2
TAX
.HL5 DECX2

LDAY1
LSRA
LSRA
LSRA
ORA#&60
STASCH
LDAY1
AND#7
STASC
TXA
AND#&F8
TAY

.HL1 TXA
AND#&F8
STAT
LDAX2
AND#&F8
SEC
SBCT
BEQHL2
LSRA
LSRA
LSRA
STAR

LDAX1
AND#7
TAX
LDATWFR,X
EOR(SC),Y
STA(SC),Y
TYA
ADC#8
TAY
LDXR
DEX
BEQHL3

CLC
.HLL1 LDA#FF
EOR(SC),Y
STA(SC),Y
TYA
ADC#8
TAY
DEX
BNEHLL1

.HL3 LDAX2
AND#7
TAX
LDATWFL,X
EOR(SC),Y
STA(SC),Y
LDYYSAV
RTS

.HL2 LDAX1
AND#7
TAX
LDATWFR,X
STAT
LDAX2
AND#7
TAX
LDATWFL,X
ANDT
EOR(SC),Y
STA(SC),Y
LDYYSAV
RTS

.TWFL EQUD&F0E0C080
EQUW&FCF8
EQUB&FE
.TWFR EQUD&1F3F7FFF
EQUD&0103070F

.PX3 LDATWOS,X
EOR(SC),Y
STA(SC),Y
LDYT1
RTS

.PIX1 JSRADD
STAYY+1
TXA
STASYL,Y

.PIXEL2
LDAX1
BPLPX1
EOR#&7F
CLC
ADC#1
.PX1 EOR#128
TAX
LDAY1
AND#127
CMP#96
BCSPX4
LDAY1
BPLPX2
EOR#&7F
ADC#1
.PX2 STAT
LDA#97
SBCT

.PIXEL STYT1
TAY
LSRA
LSRA
LSRA
ORA#&60
STASCH
TXA
AND#&F8
STASC
TYA
AND#7
TAY
TXA
AND#7
TAX

LDAZZ
CMP#&90
BCSPX3
LDATWOS2,X
EOR(SC),Y
STA(SC),Y
LDAZZ
CMP#&50
BCSPX13
DEY
BPLPX14
LDY#1
.PX14 LDATWOS2,X
EOR(SC),Y
STA(SC),Y
.PX13 LDYT1
.PX4 RTS

.BLINE TXA
ADCK4
STAK6+2
LDAK4+1
ADCT
STAK6+3

LDAFLAG
BEQBL1
INCFLAG
.BL5 LDYLSP
LDA#FF
CMPLSY2-1,Y
BEQBL7
STALSY2,Y
INCLSP
BNEBL7
.BL1 LDAK5
STAXX15
LDAK5+1
STAXX15+1

LDAK5+2
STAXX15+2
LDAK5+3
STAXX15+3

LDAK6
STAXX15+4
LDAK6+1
STAXX15+5

LDAK6+2
STAXX12
LDAK6+3
STAXX12+1

JSRLL145
BCSBL5
LDASWAP
BEQBL9
LDAX1
LDYX2
STAX2
STYX1
LDAY1
LDYY2
STAY2
STYY1
.BL9

LDYLSP
LDALSY2-1,Y
CMP#FF
BNEBL8
LDAX1
STALSX2,Y
LDAY1
STALSY2,Y
INY
.BL8 LDAX2
STALSX2,Y
LDAY2
STALSY2,Y
INY
STYLSP
JSRLOIN

LDAXX13
BNEBL5

.BL7 LDAK6
STAK5
LDAK6+1
STAK5+1
LDAK6+2
STAK5+2
LDAK6+3
STAK5+3
LDACNT
CLC
ADCSTP
STACNT
RTS

.FLIP \LDAMJ\BNEFLIP-1
LDYNOSTM
.FLL1 LDXSY,Y
LDASX,Y
STAY1
STASY,Y
TXA
STAX1
STASX,Y
LDASZ,Y
STAZZ
JSRPIXEL2
DEY
BNEFLL1
RTS

.STARS \LDA#FF
\STACOL
LDXVIEW
BEQSTARS1
DEX
BNEST11
JMPSTARS6
.ST11 JMPSTARS2

.STARS1
LDYNOSTM
.STL1 JSRDV42
LDAR
LSRP
RORA
LSRP
RORA
ORA#1
STAQ

LDASZL,Y
SBCDELT4
STASZL,Y
LDASZ,Y
STAZZ
SBCDELT4+1
STASZ,Y

JSRMLU1
STAYY+1
LDAP
ADCSYL,Y
STAYY
STAR
LDAY1
ADCYY+1
STAYY+1
STAS

LDASX,Y
STAX1
JSRMLU2
STAXX+1
LDAP
ADCSXL,Y
STAXX
LDAX1
ADCXX+1
STAXX+1

EORALP2+1
JSRMLS1
JSRADD
STAYY+1
STXYY

EORALP2
JSRMLS2
JSRADD
STAXX+1
STXXX

LDXBET1
LDAYY+1
EORBET2+1
JSRMULTS-2
STAQ
JSRMUT2
ASLP
ROLA
STAT
LDA#0
RORA
ORAT
JSRADD
STAXX+1
TXA
STASXL,Y

LDAYY
STAR
LDAYY+1
STAS
\JSRMADSTASSTXR
LDA#0
STAP
LDABETA
EOR#128

JSRPIX1
LDAXX+1
STAX1
STASX,Y
AND#127
CMP#120
BCSKILL1
LDAYY+1
STASY,Y
STAY1
AND#127
CMP#120
BCSKILL1

LDASZ,Y
CMP#16
BCCKILL1
STAZZ

.STC1 JSRPIXEL2
DEY
BEQP%+5
JMPSTL1
RTS

.KILL1 JSRDORND
ORA#4
STAY1
STASY,Y
JSRDORND
ORA#8
STAX1
STASX,Y
JSRDORND
ORA#&90
STASZ,Y
STAZZ
LDAY1
JMPSTC1

.STARS6

LDYNOSTM
.STL6 JSRDV42
LDAR
LSRP
RORA
LSRP
RORA
ORA#1
STAQ

LDASX,Y
STAX1
JSRMLU2
STAXX+1
LDASXL,Y
SBCP
STAXX
LDAX1
SBCXX+1
STAXX+1

JSRMLU1
STAYY+1
LDASYL,Y
SBCP
STAYY
STAR
LDAY1
SBCYY+1
STAYY+1
STAS

LDASZL,Y
ADCDELT4
STASZL,Y
LDASZ,Y
STAZZ
ADCDELT4+1
STASZ,Y

LDAXX+1
EORALP2
JSRMLS1
JSRADD
STAYY+1
STXYY

EORALP2+1
JSRMLS2
JSRADD
STAXX+1
STXXX

LDAYY+1
EORBET2+1
LDXBET1
JSRMULTS-2
STAQ
LDAXX+1
STAS
EOR#128
JSRMUT1
ASLP
ROLA
STAT
LDA#0
RORA
ORAT
JSRADD
STAXX+1
TXA
STASXL,Y

LDAYY
STAR
LDAYY+1
STAS
\EOR#128
\JSRMADSTASSTXR
LDA#0
STAP
LDABETA

JSRPIX1
LDAXX+1
STAX1
STASX,Y
LDAYY+1
STASY,Y
STAY1
AND#127
CMP#110
BCSKILL6

LDASZ,Y
CMP#160
BCSKILL6
STAZZ

.STC6 JSRPIXEL2
DEY
BEQST3
JMPSTL6
.ST3 RTS

.KILL6 JSRDORND
AND#127
ADC#10
STASZ,Y
STAZZ
LSRA
BCSST4
LSRA
LDA#&FC
RORA
STAX1
STASX,Y
JSRDORND
STAY1
STASY,Y
JMPSTC6

.ST4 JSRDORND
STAX1
STASX,Y
LSRA
LDA#230
RORA
STAY1
STASY,Y
BNESTC6

.PRXS EQUW1
EQUW300
EQUW4000
EQUW6000
EQUW4000
EQUW10000
EQUW5250
EQUW10000
EQUW9000
EQUW15000
EQUW10000
EQUW50000

.st4 LDX#9
CMP#25
BCSst3
DEX
CMP#10
BCSst3
DEX
CMP#2
BCSst3
DEX
BNEst3

.STATUS LDA#8
JSRTT66
JSRTT111
LDA#7
STAXC
LDA#126
JSRNLIN3
LDA#15
LDYQQ12
BNEst6
LDA#230
LDYMANY+AST
LDXFRIN+2,Y
BEQst6
LDYENERGY
CPY#128
ADC#1
.st6 JSRplf
LDA#125
JSRspc
LDA#19
LDYFIST
BEQst5
CPY#50
ADC#1
.st5 JSRplf
LDA#16

JSRspc
LDATALLY+1
BNEst4
TAX
LDATALLY
LSRA
LSRA
INX
LSRA
BNEP%-2
.st3 TXA
CLC
ADC#21
JSRplf

LDA#18
JSRplf2
LDACRGO
CMP#26
BCCP%+7
LDA#&6B
JSRplf2
LDABST
BEQP%+7
LDA#111
JSRplf2
LDAECM
BEQP%+7
LDA#&6C
JSRplf2
LDA#113
STAXX4
.stqv TAY
LDXBOMB-113,Y
BEQP%+5
JSRplf2
INCXX4
LDAXX4
CMP#117
BCCstqv

LDX#0
.st STXCNT
LDYLASER,X
BEQst1
TXA
CLC
ADC#96
JSRspc
LDA#103
LDXCNT
LDYLASER,X
BPLP%+4
LDA#104
JSRplf2
.st1 LDXCNT
INX
CPX#4
BCCst
RTS

.plf2 JSRplf
LDX#6
STXXC
RTS

.TENS EQUD&E87648

.pr2 LDA#3
LDY#0

.TT11 STAU
LDA#0
STAK
STAK+1
STYK+2
STXK+3
.BPRNT LDX#11
STXT
PHP
BCCTT30
DECT
DECU

.TT30 LDA#11
SEC
STAXX17
SBCU
STAU
INCU
LDY#0
STYS
JMPTT36

.TT35 ASLK+3
ROLK+2
ROLK+1
ROLK
ROLS
LDX#3
.tt35 LDAK,X
STAXX15,X
DEX
BPLtt35
LDAS
STAXX15+4

ASLK+3
ROLK+2
ROLK+1
ROLK
ROLS
ASLK+3
ROLK+2
ROLK+1
ROLK
ROLS
CLC
LDX#3
.tt36 LDAK,X
ADCXX15,X
STAK,X
DEX
BPLtt36
LDAXX15+4
ADCS
STAS

LDY#0
.TT36 LDX#3
SEC
.tt37 LDAK,X
SBCTENS,X
STAXX15,X
DEX
BPLtt37
LDAS
SBC#23
STAXX15+4

BCCTT37
LDX#3
.tt38 LDAXX15,X
STAK,X
DEX
BPLtt38
LDAXX15+4
STAS
INY
JMPTT36

.TT37 TYA
BNETT32
LDAT
BEQTT32
DECU
BPLTT34
LDA#32
BNEtt34
.TT32 LDY#0
STYT
CLC
ADC#B
.tt34 JSRTT26

.TT34 DECT
BPLP%+4
INCT
DECXX17
BMIRR3+1 \!!
BNEP%+10
PLP
BCCP%+7
LDA#&2E
JSRTT26
JMPTT35

.BELL LDA#7

.TT26 \PRINT
STAK3
STYYSAV2
STXXSAV2
LDYQQ17
CPY#FF
BEQRR4

CMP#7
BEQR5
CMP#32
BCSRR1
CMP#10
BEQRRX1
LDX#1
STXXC
.RRX1 INCYC
BNERR4

.RR1 \LDX#(K3 MOD256)\INX\STXP+1\DEX\LDY#(K3 DIV256)\STYP+2\LDA#10\JSROSWORD
TAY
LDX#&BF
ASLA
ASLA
BCCP%+4
LDX#&C1
ASLA
BCCP%+3
INX
STAP+1
STXP+2

LDAXC
ASLA
ASLA
ASLA
STASC
LDAYC
CPY#&7F
BNERR2
DECXC
ADC#&5E
TAX
LDY#&F8
JSRZES2
BEQRR4
.RR2 INCXC
\LDAYC
CMP#24
BCCRR3
JSRTTX66
JMPRR4

.RR3 ORA#&60
.RREN STASC+1
LDY#7
.RRL1 LDA(P+1),Y
EOR(SC),Y
STA(SC),Y
DEY
BPLRRL1

.RR4 LDYYSAV2
LDXXSAV2
LDAK3
CLC
.rT9 RTS

.R5 JSRBEEP
JMPRR4

.DIALS LDA#&D0
STASC
LDA#&78
STASC+1
JSRPZW
STXK+1
STAK
LDA#14
STAT1
LDADELTA
\LSRA
JSRDIL-1

LDA#0
STAR
STAP
LDA#8
STAS
LDAALP1
LSRA
LSRA
ORAALP2
EOR#128
JSRADD
JSRDIL2
LDABETA
LDXBET1
BEQP%+4
SBC#1
JSRADD
JSRDIL2

LDAMCNT
AND#3
BNErT9
LDY#0
JSRPZW
STXK
STAK+1
LDX#3
STXT1
.DLL23 STYXX12,X
DEX
BPLDLL23
LDX#3
LDAENERGY
LSRA
LSRA
STAQ
.DLL24 SEC
SBC#16
BCCDLL26
STAQ
LDA#16
STAXX12,X
LDAQ
DEX
BPLDLL24
BMIDLL9
.DLL26

LDAQ
STAXX12,X
.DLL9 LDAXX12,Y
STYP
JSRDIL
LDYP
INY
CPY#4
BNEDLL9

LDA#&78
STASC+1
LDA#16
\"�<80<
STASC
LDAFSH
JSRDILX
LDAASH
JSRDILX
LDAQQ14
JSRDILX+2

JSRPZW
STXK+1
STAK
LDX#11
STXT1
LDACABTMP
JSRDILX
LDAGNTMP
JSRDILX

LDA#&F0
STAT1
STAK+1
LDAALTIT
JSRDILX
JMPCOMPAS

.PZW LDX#&F0
LDAMCNT
AND#8
ANDFLH
BEQP%+4
TXA
EQUB&2C
LDA#15
RTS

.DILX LSRA
LSRA
LSRA
LSRA

.DIL STAQ
LDX#FF
STXR
CMPT1
BCSDL30
LDAK+1
BNEDL31
.DL30 LDAK
.DL31 STACOL
LDY#2
LDX#3
.DL1 LDAQ
CMP#4
BCCDL2
SBC#4
STAQ
LDAR
.DL5 ANDCOL
STA(SC),Y
INY
STA(SC),Y
INY
STA(SC),Y
TYA
CLC
ADC#6
TAY
DEX
BMIDL6
BPLDL1

.DL2 EOR#3
STAQ
LDAR
.DL3 ASLA
AND#239
DECQ
BPLDL3
PHA
LDA#0
STAR
LDA#99
STAQ
PLA
JMPDL5
.DL6 INCSC+1
.DL9 RTS

.DIL2 LDY#1
STAQ
.DLL10 SEC
LDAQ
SBC#4
BCSDLL11
LDA#FF
LDXQ
STAQ
LDACTWOS,X
AND#&F0
BNEDLL12
.DLL11 STAQ
LDA#0
.DLL12 STA(SC),Y
INY
STA(SC),Y
INY
STA(SC),Y
INY
STA(SC),Y
TYA
CLC
ADC#5
TAY
CPY#30
BCCDLL10
INCSC+1
RTS

.TVT1 EQUD&8494C4D4
\TVT2
EQUD&A5B5E5F5
EQUD&26366676
EQUD&A1B1F1E1
\TVT3
EQUD&A0B0E0F0
EQUD&8090C0D0
EQUD&27376777

.LINSCN LDA#30
STADL
STAUSVIA+4
LDA#VSCAN
STAUSVIA+5
LDAHFX
BNEVNT1
LDA#8
STA&FE20
.VNT3 LDATVT1+16,Y
STA&FE21
DEY
BPLVNT3
LDALASCT
BEQP%+5
DECLASCT
\VNT4
LDAsvn
BNEjvec
PLA
TAY
LDA&FE41
LDA&FC
RTI

.IRQ1 TYA
PHA
LDY#11
LDA#2
BITVIA+&D
BNELINSCN
BVCjvec
ASLA\4
STA&FE20
LDAESCP
BNEVNT1
\VNT2
LDATVT1,Y
STA&FE21
DEY
BPLP%-7
.jvec PLA
TAY
JMP(VEC)
.VNT1 LDY#7
LDATVT1+8,Y
STA&FE21
DEY
BPLVNT1+2
BMIjvec

.ESCAPE LDAMJ
PHA
JSRRES2
LDX#CYL
STXTYPE
JSRFRS1
LDA#8
STAINWK+27
LDA#&C2
STAINWK+30
LSRA
STAINWK+32
.ESL1 JSRMVEIT
JSRLL9
DECINWK+32
BNEESL1
JSRSCAN
JSRRESET
PLA
BEQP%+5
JMPDEATH
LDX#16
.ESL2 STAQQ20,X
DEX
BPLESL2
STAFIST
STAESCP
LDA#70
STAQQ14
JMPBAY

;IFZ>4OSCLI("S.ELTB "+STR$~W%+" "+STR$~O%+" "+STR$~L%+" "+STR$~H%)
;PRINT "S.ELTB ",~W%," ",~O%," ",~L%," ",~H_B%

PRINT "ELITE<B>"
PRINT "ASSEMBLE AT W%=", ~C_B%
PRINT "P%=",~P%
PRINT "CODE SIZE=", ~(P%-C_B%)
PRINT "EXECUTE AT L%=", ~L%
PRINT "RELOAD AT H%=", ~H_B%

PRINT "S.ELTB ",~C_B%," ",~P%," ",~L%," ",~H_B%
SAVE "output/ELTB.bin", C_B%, P%, L%
PRINT "B done,";

\************************************************
\* ELITE<C>
\************************************************

;O%=W%
;H%=L%+P%-C%
C_C%=P%
H_C%=L%+P%-C_A%

\[OPTZ

.TA34 LDA#0
JSRMAS4
BEQP%+5
JMPTA21
JSRTA87+3
JSREXNO3
LDA#250
JMPOOPS

.TA18\msl

LDAECMA
BNETA35
LDAINWK+32
ASLA
BMITA34
LSRA

TAX
LDAUNIV,X
STAV
LDAUNIV+1,X
STAV+1
LDY#2
JSRTAS1
LDY#5
JSRTAS1
LDY#8
JSRTAS1

LDAK3+2
ORAK3+5
ORAK3+8
AND#127
ORAK3+1
ORAK3+4
ORAK3+7
BNETA64

LDAINWK+32
CMP#&82
BEQTA35
LDY#31
LDA(V),Y
BITM32+1
BNETA35
ORA#128
STA(V),Y
.TA35 LDAINWK
ORAINWK+3
ORAINWK+6
BNETA87
LDA#80
JSROOPS
.TA87 JSREXNO2
ASLINWK+31
SEC
RORINWK+31

.TA1 RTS

.TA64 JSRDORND
CMP#16
BCSTA19
.M32 LDY#32
LDA(V),Y
LSRA
BCCTA19
JMPECBLB2

.TACTICS

CPX#MSL
BEQTA18
CPX#ESC
BNEP%+8
JSRSPS1
JMPTA15
CPX#SST
BNETA13
JSRDORND
CMP#140
BCCTA14-1
LDAMANY+SH3
CMP#4
BCSTA14-1
LDX#COPS
LDA#&F1
JMPSFS1
.TA13

CPX#TGL
BNETA14
LDAMANY+THG
BNETA14
LSRINWK+32
ASLINWK+32
LSRINWK+27
RTS
.TA14 CPX#CYL
BCSTA62
CPX#COPS
BEQTA62
LDASSPR
BEQTA62
LDAINWK+32
AND#129
STAINWK+32

.TA62 LDY#14
LDAINWK+35
CMP(XX0),Y
BCSTA21
INCINWK+35
.TA21

LDX#8
.TAL1 LDAINWK,X
STAK3,X
DEX
BPLTAL1

.TA19 JSRTAS2\XX15=r~96

LDY#10
JSRTAS3
STACNT
LDATYPE
CMP#MSL
BNEP%+5
JMPTA20
JSRDORND
CMP#250
BCCTA7
JSRDORND
ORA#&68
STAINWK+29
.TA7\VRol

LDY#14
LDA(XX0),Y
LSRA
CMPINWK+35
BCCTA3
LSRA
LSRA
CMPINWK+35
BCCta3
JSRDORND
CMP#230
BCCta3
LDATYPE
CMP#THG
BEQta3
LDA#0
STAINWK+32
JMPSESCP

.ta3 LDAINWK+31
AND#7
BEQTA3
STAT
JSRDORND
AND#31
CMPT
BCSTA3
LDAECMA
BNETA3
DECINWK+31
LDATYPE
CMP#THG
BNETA16
LDX#TGL
LDAINWK+32
JMPSFS1
.TA16 JMPSFRMIS
.TA3

LDA#0
JSRMAS4
AND#&E0
BNETA4
LDXCNT
CPX#160
BCCTA4
LDAINWK+31
ORA#64
STAINWK+31
CPX#163
BCCTA4

LDY#19
LDA(XX0),Y
LSRA
JSROOPS
DECINWK+28
LDAECMA
BNETA10
LDA#8
JMPNOISE
\frLs

.TA4 LDAINWK+7
CMP#3
BCSTA5
LDAINWK+1
ORAINWK+4
AND#&FE
BEQTA15
.TA5 JSRDORND
ORA#128
CMPINWK+32
BCSTA15

.TA20 LDAXX15
EOR#128
STAXX15
LDAXX15+1
EOR#128
STAXX15+1
LDAXX15+2
EOR#128
STAXX15+2
LDACNT
EOR#128
STACNT

.TA15\^XX15

LDY#16
JSRTAS3
EOR#128
AND#128
ORA#3
STAINWK+30

LDAINWK+29
AND#127
CMP#16
BCSTA6

LDY#22
JSRTAS3
EORINWK+30
AND#128
EOR#&85
STAINWK+29

.TA6 LDACNT
BMITA9
CMP#22
BCCTA9
LDA#3
STAINWK+28
RTS

.TA9 AND#127
CMP#18
BCCTA10
LDA#FF
LDXTYPE
CPX#MSL
BNEP%+3
ASLA
STAINWK+28
.TA10 RTS

.TAS1 LDA(V),Y
EOR#128
STAK+3
DEY
LDA(V),Y
STAK+2
DEY
LDA(V),Y
STAK+1
STYU
LDXU
JSRMVT3
LDYU

STAK3+2,X
LDAK+2
STAK3+1,X
LDAK+1
STAK3,X
RTS

.HITCH CLC
LDAINWK+8
BNEHI1
LDATYPE
BMIHI1
LDAINWK+31
AND#32
ORAINWK+1
ORAINWK+4
BNEHI1

LDAINWK
JSRSQUA2
STAS
LDAP
STAR

LDAINWK+3
JSRSQUA2
TAX
LDAP
ADCR
STAR
TXA
ADCS
BCSFR1-2
STAS
LDY#2
LDA(XX0),Y
CMPS
BNEHI1
DEY
LDA(XX0),Y
CMPR
.HI1 RTS

.FRS1 JSRZINF
LDA#28
STAINWK+3
LSRA
STAINWK+6
LDA#128
STAINWK+5
LDAMSTG
ASLA
ORA#128
STAINWK+32

.fq1 LDA#96
STAINWK+14
ORA#128
STAINWK+22
LDADELTA
ROLA
STAINWK+27
TXA
JMPNWSHP

.FRMIS LDX#MSL
JSRFRS1
BCCFR1
LDXMSTG
JSRGINF
LDAFRIN,X
JSRANGRY
LDY#0
JSRABORT
DECNOMSL
LDA#48
JMPNOISE

.ANGRY CMP#SST
BEQAN2
BCSHI1
CMP#CYL
BNEP%+5
JSRAN2
LDY#32
LDA(INF),Y
BEQHI1
ORA#128
STA(INF),Y
LDY#28
LDA#2
STA(INF),Y
ASLA
LDY#30
STA(INF),Y
RTS

.AN2 ASLK%+NI%+32
SEC
RORK%+NI%+32
CLC
RTS
.FR1 LDA#201
JMPMESS

.SESCP LDX#ESC
LDA#&FE
.SFS1 STAT1
LDAXX0
PHA
LDAXX0+1
PHA
LDAINF
PHA
LDAINF+1
PHA
LDY#NI%-1
.FRL2 LDAINWK,Y
STAXX3,Y
LDA(INF),Y
STAINWK,Y
DEY
BPLFRL2

LDATYPE
CMP#SST
BNErx
TXA
PHA
LDA#32
STAINWK+27
LDX#0
LDAINWK+10
JSRSFS2
LDX#3
LDAINWK+12
JSRSFS2
LDX#6
LDAINWK+14
JSRSFS2
PLA
TAX
.rx

LDAT1
STAINWK+32
LSRINWK+29
ASLINWK+29
TXA
CMP#OIL
BNENOIL
JSRDORND
ASLA
STAINWK+30
TXA
AND#15
STAINWK+27
LDA#FF
RORA
STAINWK+29
LDA#OIL
.NOIL JSRNWSHP

PLA
STAINF+1
PLA
STAINF
LDX#NI%-1
.FRL3 LDAXX3,X
STAINWK,X
DEX
BPLFRL3
PLA
STAXX0+1
PLA
STAXX0
RTS

.SFS2 ASLA
STAR
LDA#0
RORA
JMPMVT1

.LL164 LDA#56
JSRNOISE
LDA#1
STAHFX
LDA#4
JSRHFS2
DECHFX
RTS

.LAUN LDA#48
JSRNOISE
LDA#8
.HFS2 STASTP
JSRTTX66
JSRHFS1

.HFS1 LDA#128
STAK3
LDX#Y
STXK4
ASLA
STAXX4
STAK3+1
STAK4+1
.HFL5 JSRHFL1
INCXX4
LDXXX4
CPX#8
BNEHFL5
RTS

.HFL1 LDAXX4
AND#7
CLC
ADC#8
STAK
.HFL2 LDA#1
STALSP
JSRCIRCLE2
ASLK
BCSHF8
LDAK
CMP#160
BCCHFL2
.HF8 RTS

.STARS2 LDA#0
CPX#2
RORA
STARAT
EOR#128
STARAT2
JSRST2

LDYNOSTM
.STL2 LDASZ,Y
STAZZ
LSRA
LSRA
LSRA
JSRDV41
LDAP
EORRAT2
STAS
LDASXL,Y
STAP
LDASX,Y
STAX1
JSRADD

STAS
STXR
LDASY,Y
STAY1
EORBET2
LDXBET1
JSRMULTS-2
JSRADD
STXXX
STAXX+1

LDXSYL,Y
STXR
LDXY1
STXS
LDXBET1
EORBET2+1
JSRMULTS-2
JSRADD
STXYY
STAYY+1

LDXALP1
EORALP2
JSRMULTS-2
STAQ
LDAXX
STAR
LDAXX+1
STAS
EOR#128
JSRMAD
STAXX+1
TXA
STASXL,Y

LDAYY
STAR
LDAYY+1
STAS
JSRMAD
STAS
STXR
LDA#0
STAP
LDAALPHA

JSRPIX1
LDAXX+1
STASX,Y
STAX1

AND#127
CMP#116
BCSKILL2
LDAYY+1
STASY,Y
STAY1
AND#127
CMP#116
BCSST5
.STC2 JSRPIXEL2
DEY
BEQST2
JMPSTL2

.ST2 LDAALPHA
EORRAT
STAALPHA
LDAALP2
EORRAT
STAALP2
EOR#128
STAALP2+1
LDABET2
EORRAT
STABET2
EOR#128
STABET2+1
RTS

.KILL2 JSRDORND
STAY1
STASY,Y
LDA#115
ORARAT
STAX1
STASX,Y
BNESTF1

.ST5 JSRDORND
STAX1
STASX,Y
LDA#110
ORAALP2+1
STAY1
STASY,Y
.STF1 JSRDORND
ORA#8
STAZZ
STASZ,Y
BNESTC2

.SNE

FORI%,0,31
N=ABS(SIN(I%/64*2*PI))
;IFN>=1 I%?O%=FF
;ELSEI%?O%=INT(256*N+.5)
IF N>=1
    EQUB FF
ELSE
    EQUB INT(256*N+.5)
ENDIF
NEXT

;O%=O%+32
;P%=P%+32

.MU5 STAK
STAK+1
STAK+2
STAK+3
CLC
RTS

.MULT3\K(4)=AP(2)*Q
STAR
AND#127
STAK+2
LDAQ
AND#127
BEQMU5
SEC
SBC#1
STAT
LDAP+1
LSRK+2
RORA
STAK+1
LDAP
RORA
STAK
LDA#0
LDX#24

.MUL2 BCCP%+4
ADCT
RORA
RORK+2
RORK+1
RORK
DEX
BNEMUL2
STAT
LDAR
EORQ
AND#128
ORAT
STAK+3
RTS

.MLS2 LDXXX
STXR
LDXXX+1
STXS
.MLS1 LDXALP1
STXP

.MULTS\AP=A*P(P+<32)

TAX
AND#128
STAT
TXA
AND#127
BEQMU6
TAX
DEX
STXT1
LDA#0

LSRP
BCCP%+4
ADCT1
RORA
RORP
BCCP%+4
ADCT1
RORA
RORP
BCCP%+4
ADCT1
RORA
RORP
BCCP%+4
ADCT1
RORA
RORP
BCCP%+4
ADCT1
RORA
RORP

LSRA
RORP
LSRA
RORP
LSRA
RORP
ORAT
RTS

.SQUA\AP=A*ApresQ
AND#127
.SQUA2 STAP
TAX
BNEMU11
.MU1 CLC
STXP
TXA
RTS

.MLU1 LDASY,Y
STAY1
.MLU2 AND#127
STAP

.MULTU\AP=P*Qunsg

LDXQ
BEQMU1
.MU11 DEX
STXT
LDA#0
LDX#8
LSRP
{
.MUL6 BCCP%+4
ADCT
RORA
RORP
DEX
BNEMUL6
RTS
}

.MU6 STAP+1
STAP
RTS

.FMLTU2 AND#31
TAX
LDASNE,X
STAQ
LDAK

.FMLTU\A=A*Q/256unsg
EOR#FF
SEC
RORA
STAP
LDA#0
.MUL3 BCSMU7
ADCQ
RORA
LSRP
BNEMUL3
RTS
.MU7 LSRA
LSRP
BNEMUL3
RTS

LDXQ
BEQMU1
DEX
STXT
LDA#0
LDX#8
LSRP
{
.MUL6 BCCP%+4
ADCT
RORA
RORP
DEX
BNEMUL6
RTS
}

STXQ
.MLTU2\AP(2)=AP*Qunsg(EORP)
EOR#FF
LSRA
STAP+1
LDA#0
LDX#16
RORP
.MUL7 BCSMU21
ADCQ
RORA
RORP+1
RORP
DEX
BNEMUL7
RTS
.MU21 LSRA
RORP+1
RORP
DEX
BNEMUL7
RTS

.MUT3 LDXALP1
STXP
.MUT2 LDXXX+1
STXS

.MUT1 LDXXX
STXR

.MULT1 \AP=Q*A

TAX
AND#127
LSRA
STAP
TXA
EORQ
AND#128
STAT
LDAQ
AND#127
BEQmu10
TAX
DEX
STXT1
LDA#0
LDX#7

.MUL4 BCCP%+4
ADCT1
RORA
RORP
DEX
BNEMUL4
LSRA
RORP
ORAT
RTS
.mu10 STAP
RTS

.MULT12 JSRMULT1
STAS
LDAP
STAR
RTS

.TAS3 LDXINWK,Y
STXQ
LDAXX15
JSRMULT12
LDXINWK+2,Y
STXQ
LDAXX15+1
JSRMAD
STAS
STXR

LDXINWK+4,Y
STXQ
LDAXX15+2
.MAD JSRMULT1

.ADD\AX=AP+SR

STAT1
AND#128
STAT
EORS
BMIMU8
LDAR
CLC
ADCP
TAX
LDAS
ADCT1
ORAT
RTS

.MU8 LDAS
AND#127
STAU
LDAP
SEC
SBCR
TAX
LDAT1
AND#127
SBCU
BCSMU9
STAU
TXA
EOR#FF
ADC#1
TAX
LDA#0
SBCU
ORA#128
.MU9 EORT
RTS

\DVIDT(A=AP/Q)inF

.TIS1 STXQ
EOR#128
JSRMAD

.DVID96\A=A/96
TAX
AND#128
STAT
TXA
AND#127
LDX#254
STXT1
.DVL3 ASLA
CMP#96
BCCDV4
SBC#96
.DV4 ROLT1
BCSDVL3
LDAT1
ORAT
RTS

.DV42 LDASZ,Y
.DV41 STAQ
LDADELTA

.DVID4\P-R=A/Qunsg

LDX#8
ASLA
STAP
LDA#0
.DVL4 ROLA
BCSDV8
CMPQ
BCCDV5
.DV8 SBCQ
SEC
.DV5 ROLP
DEX
BNEDVL4
JMPLL28+4

.DVID3B2 STAP+2
LDAINWK+6
STAQ
LDAINWK+7
STAR
LDAINWK+8
STAS

.DVID3B\K+1(3)-K=P(3)/SRQaprx

LDAP
ORA#1
STAP
LDAP+2
EORS
AND#128
STAT
LDY#0
LDAP+2
AND#127
.DVL9 CMP#&40
BCSDV14
ASLP
ROLP+1
ROLA
INY
BNEDVL9

.DV14 STAP+2
LDAS
AND#127
BMIDV9
.DVL6 DEY
ASLQ
ROLR
ROLA
BPLDVL6
.DV9 STAQ
LDA#254
STAR
LDAP+2
JSRLL31

LDA#0
STAK+1
STAK+2
STAK+3
TYA
BPLDV12
LDAR
.DVL8 ASLA
ROLK+1
ROLK+2
ROLK+3
INY
BNEDVL8
STAK
LDAK+3
ORAT
STAK+3
RTS

.DV13 LDAR
STAK
LDAT
STAK+3
RTS

.DV12 BEQDV13
LDAR
.DVL10 LSRA
DEY
BNEDVL10
STAK
LDAT
STAK+3
RTS

.cntr LDADAMP
BNERE1
TXA
BPLBUMP
DEX
BMIRE1

.BUMP INX
BNERE1

.REDU DEX
BEQBUMP
.RE1 RTS

.BUMP2 STAT
TXA
CLC
ADCT
TAX
BCCRE2
LDX#FF
.RE2 BPLRE3+2
LDAT
RTS

.REDU2 STAT
TXA
SEC
SBCT
TAX
BCSRE3
LDX#1
.RE3 BPLRE2+2
LDADJD
BNERE2+2
LDX#128
BMIRE2+2

.ARCTAN\A=TAN-1(P/Q)

LDAP
EORQ
STAT1
LDAQ
BEQAR2
ASLA
STAQ
LDAP
ASLA
CMPQ
BCSAR1
JSRARS1
SEC
.AR4 LDXT1
BMIAR3
RTS

.AR1 LDXQ
STAQ
STXP
TXA
JSRARS1
STAT
LDA#64
SBCT
BCSAR4
.AR2 LDA#63
RTS
.AR3 STAT
LDA#128
\SEC
SBCT
RTS

.ARS1 JSRLL28
LDAR
LSRA
LSRA
LSRA
TAX
LDAACT,X
RTS

.ACT

FOR I%,0,31
;I%?O%=INT(128/PI*ATN(I%/32)+.5)
EQUB INT(128/PI*ATN(I%/32)+.5)
NEXT
;P%=P%+32
;O%=O%+32

.WARP LDAMANY+AST
CLC
ADCMANY+ESC
CLC         ; NOT IN ELITEC.TXT but is in ELITE SOURCE IMAGE

ADCMANY+OIL
TAX
LDAFRIN+2,X
ORASSPR
ORAMJ
BNEWA1
LDYK%+8
BMIWA3
TAY
JSRMAS2
;LSRA
;BEQWA1
CMP #2
BCC WA1     ; NOT IN ELITEC.TXT but is in ELITE SOURCE IMAGE
.WA3 LDYK%+NI%+8
BMIWA2
LDY#NI%
JSRm
;LSRA
;BEQWA1
CMP #2
BCC WA1     ; NOT IN ELITEC.TXT but is in ELITE SOURCE IMAGE
.WA2

LDA#&81
STAS
STAR
STAP
LDAK%+8
JSRADD
STAK%+8
LDAK%+NI%+8
JSRADD
STAK%+NI%+8

LDA#1
STAQQ11
STAMCNT
LSRA
STAEV
LDXVIEW
JMPLOOK1
.WA1 LDA#40
JMPNOISE

.LASLI JSRDORND
AND#7
ADC#Y-4
STALASY
JSRDORND
AND#7
ADC#X-4
STALASX
LDAGNTMP
ADC#8
STAGNTMP
JSRDENGY

.LASLI2 LDAQQ11
BNEPU1-1
LDA#32
LDY#224
JSRlas
LDA#48
LDY#208

.las STAX2
LDALASX
STAX1
LDALASY
STAY1
LDA#2*Y-1
STAY2
JSRLOIN
LDALASX
STAX1
LDALASY
STAY1
STYX2
LDA#2*Y-1
STAY2
JMPLOIN

.PLUT LDXVIEW
BNEPU1
RTS
.PU1 DEX
BNEPU2

LDAINWK+2
EOR#128
STAINWK+2
LDAINWK+8
EOR#128
STAINWK+8
LDAINWK+10
EOR#128
STAINWK+10
LDAINWK+14
EOR#128
STAINWK+14
LDAINWK+16
EOR#128
STAINWK+16

LDAINWK+20
EOR#128
STAINWK+20
LDAINWK+22
EOR#128
STAINWK+22
LDAINWK+26
EOR#128
STAINWK+26
RTS

.PU2 LDA#0
CPX#2
RORA
STARAT2
EOR#128
STARAT

LDAINWK
LDXINWK+6
STAINWK+6
STXINWK
LDAINWK+1
LDXINWK+7
STAINWK+7
STXINWK+1
LDAINWK+2
EORRAT
TAX
LDAINWK+8
EORRAT2
STAINWK+2
STXINWK+8

LDY#9
JSRPUS1

LDY#15
JSRPUS1

LDY#21

.PUS1 LDAINWK,Y
LDXINWK+4,Y
STAINWK+4,Y
STXINWK,Y
LDAINWK+1,Y
EORRAT
TAX
LDAINWK+5,Y
EORRAT2
STAINWK+1,Y
STXINWK+5,Y
.LO2 RTS

.LQ STXVIEW
JSRTT66
JSRSIGHT
JMPNWSTARS

.LOOK1 LDA#0
LDYQQ11
BNELQ
CPXVIEW
BEQLO2
STXVIEW
JSRTT66
JSRFLIP
JSRWPSHPS

.SIGHT LDYVIEW
LDALASER,Y
BEQLO2
LDA#128
STAQQ19
LDA#Y-24
STAQQ19+1
LDA#20
STAQQ19+2
JSRTT15
LDA#10
STAQQ19+2
JMPTT15

LDA#1
.TT66 STAQQ11
.TTX66 LDA#128
STAQQ17
ASLA
STALASCT            ; is LAS2 in ELITEC.TXT
STADLY
STAde
LDX#&60
.BOL1 JSRZES1
INX
CPX#&78
BNEBOL1

LDXQQ22+1
BEQBOX
JSRee3
.BOX LDY#1
STYYC
LDAQQ11
BNEtt66
LDY#11
STYXC
LDAVIEW
ORA#&60
JSRTT27
JSRTT162
LDA#175
JSRTT27
.tt66

LDX#0
STXX1
STXY1
STXQQ17
DEX
STXX2
JSRHLOIN

LDA#2
STAX1
STAX2
JSRBOS2

.BOS2 JSRBOS1
.BOS1 LDA#0
STAY1
LDA#2*Y-1
STAY2
DECX1
DECX2
JMPLOIN

LDY#2
EQUB&2C
.DEL8 LDY#8
.DELAY JSRWSCAN
DEY
BNEDELAY
RTS

.hm JSRTT103
JSRTT111
JSRTT103
LDAQQ11
BEQSC5
.CLYNS LDA#20
STAYC
LDA#&75
STASC+1
LDA#7
STASC
JSRTT67
LDA#0
JSRLYN
INCSC+1
JSRLYN
INCSC+1
INY
STYXC

.LYN LDY#233
.EE2 STA(SC),Y
DEY
BNEEE2
.SC5 RTS

.SCAN LDAINWK+31
AND#16
BEQSC5
LDATYPE
BMISC5
LDX#FF
\CMP#TGL\BEQSC49
CMP#MSL
BNEP%+4
LDX#&F0
\CMP#AST
\BCCP%+4
\LDX#&F
\SC49
STXCOL
LDAINWK+1
ORAINWK+4
ORAINWK+7
AND#&C0
BNESC5

LDAINWK+1
CLC
LDXINWK+2
BPLSC2
EOR#FF
ADC#1
.SC2 ADC#123
STAX1

LDAINWK+7
LSRA
LSRA
CLC
LDXINWK+8
BPLSC3
EOR#FF
SEC
.SC3 ADC#35
EOR#FF
STASC

LDAINWK+4
LSRA
CLC
LDXINWK+5
BMISCD6
EOR#FF
SEC
.SCD6 ADCSC
BPLld246
CMP#194
BCSP%+4
LDA#194
CMP#247
BCCP%+4
.ld246 LDA#246
STAY1
SEC
SBCSC
PHP
\BCSSC48
\EOR#FF
\ADC#1
.SC48 PHA
JSRCPIX4
LDACTWOS+1,X
ANDCOL
STAX1
PLA
PLP
TAX
BEQRTS
BCCRTS+1

.VLL1 DEY
BPLVL1
LDY#7
DECSC+1
.VL1 LDAX1
EOR(SC),Y
STA(SC),Y
DEX
BNEVLL1
.RTS RTS

INY
CPY#8
BNEP%+6
LDY#0
INCSC+1

.VLL2 INY
CPY#8
BNEVL2
LDY#0
INCSC+1
.VL2 LDAX1
EOR(SC),Y
STA(SC),Y
INX
BNEVLL2
RTS

.WSCAN LDA#0
STADL
LDADL
BEQP%-2
RTS

;IFZ>4OSCLI("S.ELTC "+STR$~W%+" "+STR$~O%+" "+STR$~L%+" "+STR$~H%)

PRINT "ELITE<C>"
PRINT "ASSEMBLE AT W%=", ~C_C%
PRINT "P%=",~P%
PRINT "CODE SIZE=", ~(P%-C_C%)
PRINT "EXECUTE AT L%=", ~L%
PRINT "RELOAD AT H%=", ~H_C%

PRINT "S.ELTC ",~C_C%," ",~P%," ",~L%," ",~H_C%
SAVE "output/ELTC.bin", C_C%, P%, L%

PRINT "C d,";

\************************************************
\* ELITE<D>
\************************************************

;H%=L%+P%-C%
;O%=W%
C_D%=P%
H_D%=L%+P%-C_A%

\[OPTZ

.tnpr pha
LDX#12
CPXQQ29
BCCkg
.Tml ADCQQ20,X
DEX
BPLTml
CMPCRGO
pla
RTS
.kg LDYQQ29
ADCQQ20,Y
cmp#200
pla
rts

.TT20 JSRP%+3
JSRP%+3

.TT54 LDAQQ15
CLC
ADCQQ15+2
TAX
LDAQQ15+1
ADCQQ15+3
TAY

LDAQQ15+2
STAQQ15
LDAQQ15+3
STAQQ15+1
LDAQQ15+5
STAQQ15+3
LDAQQ15+4
STAQQ15+2
CLC
TXA
ADCQQ15+2
STAQQ15+4
TYA
ADCQQ15+3
STAQQ15+5
RTS

.TT146 LDAQQ8
ORAQQ8+1
BNETT63
INCYC
RTS
.TT63 LDA#191
JSRTT68

LDXQQ8
LDYQQ8+1
SEC
JSRpr5
LDA#195
.TT60 JSRTT27
.TTX69 INCYC
.TT69 LDA#128
STAQQ17
.TT67 LDA#13
JMPTT27

.TT70 LDA#173
JSRTT27
JMPTT72
.spc JSRTT27
JMPTT162

.TT25\ DATA

JSRTT66-2
LDA#9
STAXC
LDA#163
JSRTT27
JSRNLIN
JSRTTX69
INCYC
JSRTT146
LDA#194

JSRTT68
LDAQQ3
CLC
ADC#1
LSRA
CMP#2
BEQTT70
LDAQQ3
BCCTT71

SBC#5
CLC
.TT71 ADC#170
JSRTT27
.TT72 LDAQQ3
LSRA
LSRA
CLC
ADC#168
JSRTT60
LDA#162
JSRTT68
LDAQQ4
CLC
ADC#177
JSRTT60
LDA#196
JSRTT68

LDXQQ5
INX
CLC
JSRpr2
JSRTTX69
LDA#192
JSRTT68
SEC
LDXQQ6
JSRpr2
LDA#198
JSRTT60
LDA#&28
JSRTT27
LDAQQ15+4
BMITT75
LDA#188
JSRTT27
JMPTT76
.TT75 LDAQQ15+5

LSRA
LSRA
PHA
AND#7
CMP#3
BCSTT205
ADC#227
JSRspc
.TT205 PLA
LSRA
LSRA
LSRA
CMP#6
BCSTT206
ADC#230
JSRspc
.TT206 LDAQQ15+3
EORQQ15+1
AND#7

STAQQ19
CMP#6
BCSTT207
ADC#236
JSRspc
.TT207 LDAQQ15+5
AND#3
CLC
ADCQQ19
AND#7
ADC#242
JSRTT27
.TT76 LDA#&53
JSRTT27
LDA#&29
JSRTT60

LDA#193
JSRTT68
LDXQQ7
LDYQQ7+1
JSRpr6
JSRTT162
LDA#0
STAQQ17
LDA#&4D
JSRTT27
LDA#226
JSRTT60
LDA#250
JSRTT68
LDAQQ15+5
LDXQQ15+3
AND#15
CLC
ADC#11
TAY

JSRpr5
JSRTT162
LDA#&6B
JSRTT26
LDA#&6D
JMPTT26

.TT24

LDAQQ15+1
AND#7
STAQQ3
LDAQQ15+2
LSRA
LSRA
LSRA
AND#7
STAQQ4
LSRA
BNETT77
LDAQQ3
ORA#2
STAQQ3
.TT77 LDAQQ3
EOR#7
CLC
STAQQ5
LDAQQ15+3
AND#3
ADCQQ5
STAQQ5

LDAQQ4
LSRA
ADCQQ5
STAQQ5
ASLA
ASLA
ADCQQ3
ADCQQ4
ADC#1
STAQQ6
LDAQQ3
EOR#7
ADC#3
STAP
LDAQQ4
ADC#4
STAQ
JSRMULTU
LDAQQ6
STAQ
JSRMULTU
ASLP
ROLA
ASLP
ROLA
ASLP
ROLA
STAQQ7+1
LDAP
STAQQ7
RTS

.TT22\Lng Sc
LDA#64
JSRTT66
LDA#7
STAXC
JSRTT81
LDA#199
JSRTT27
JSRNLIN
LDA#152
JSRNLIN2
JSRTT14

LDX#0
.TT83 STXXSAV
LDXQQ15+3
LDYQQ15+4
TYA
ORA#&50
STAZZ

LDAQQ15+1
LSRA
CLC
ADC#24
STAXX15+1
JSRPIXEL
JSRTT20
LDXXSAV
INX
BNETT83
LDAQQ9
STAQQ19
LDAQQ10
LSRA
STAQQ19+1
LDA#4
STAQQ19+2

.TT15

LDA#24
LDXQQ11
BPLP%+4
LDA#0
STAQQ19+5
LDAQQ19
SEC
SBCQQ19+2
BCSTT84
LDA#0
.TT84 STAXX15
LDAQQ19
CLC
ADCQQ19+2
BCCP%+4
LDA#FF
STAXX15+2

LDAQQ19+1
CLC
ADCQQ19+5
STAXX15+1
JSRHLOIN
LDAQQ19+1
SEC
SBCQQ19+2
BCSTT86
LDA#0
.TT86 CLC
ADCQQ19+5
STAXX15+1
LDAQQ19+1
CLC
ADCQQ19+2
ADCQQ19+5
CMP#152
BCCTT87

LDXQQ11
BMITT87
LDA#151
.TT87 STAXX15+3
LDAQQ19
STAXX15
STAXX15+2
JMPLL30

.TT126 LDA#104
STAQQ19
LDA#90
STAQQ19+1
LDA#16
STAQQ19+2
JSRTT15
LDAQQ14
STAK
JMPTT128

.TT14\Crcl/+

LDAQQ11
BMITT126
LDAQQ14
LSRA
LSRA
STAK
LDAQQ0
STAQQ19
LDAQQ1
LSRA
STAQQ19+1
LDA#7
STAQQ19+2
JSRTT15
LDAQQ19+1
CLC
ADC#24
STAQQ19+1

.TT128 LDAQQ19
STAK3
LDAQQ19+1
STAK4
LDX#0
STXK4+1
STXK3+1
\STXLSX
INX
STXLSP
LDX#2
STXSTP

JSRCIRCLE2
\LDA#FFSTALSX
RTS

.TT219\Buy

\LDA#2
JSRTT66-2
JSRTT163
LDA#128
STAQQ17
\JSRFLKB
LDA#0
STAQQ29

.TT220 JSRTT151
LDAQQ25
BNETT224
JMPTT222
.TQ4 LDY#176
.Tc JSRTT162
TYA
JSRprq
.TTX224 JSRdn2
.TT224

JSRCLYNS
LDA#204
JSRTT27
LDAQQ29
CLC
ADC#208
JSRTT27
LDA#&2F
JSRTT27
JSRTT152
LDA#&3F
JSRTT27
JSRTT67
LDX#0
STXR
LDX#12
STXT1

\.TT223     ; DUPLICATE LABEL?

JSRgnum
BCSTQ4
STAP
JSRtnpr
LDY#206
BCSTc
LDAQQ24
STAQ
JSRGCASH
JSRLCASH
LDY#197
BCCTc

LDYQQ29
LDAR
PHA
CLC
ADCQQ20,Y
STAQQ20,Y
LDAAVL,Y
SEC
SBCR
STAAVL,Y
PLA
BEQTT222
JSRdn

.TT222 LDAQQ29
CLC
ADC#5
STAYC
LDA#0
STAXC
INCQQ29
LDAQQ29
CMP#17
BCSBAY2
JMPTT220
.BAY2 LDA#f9
JMPFRCE

.gnum LDX#0
STXR
LDX#12
STXT1
.TT223 JSRTT217
STAQ
SEC
SBC#&30
BCCOUT
CMP#10
BCSBAY2
STAS
LDAR
CMP#26
BCSOUT
ASLA
STAT
ASLA
ASLA
ADCT
ADCS
STAR
CMPQQ25
BEQTT226
BCSOUT
.TT226 LDAQ
JSRTT26
DECT1
BNETT223
.OUT LDAR
RTS

.TT208\Sel

LDA#4
JSRTT66
LDA#4
STAYC
STAXC
\JSRFLKB
LDA#205
JSRTT27
LDA#206
JSRTT68

.TT210\Crgo

LDY#0
.TT211 STYQQ29
LDXQQ20,Y
BEQTT212

TYA
ASLA
ASLA
TAY
LDAQQ23+1,Y
STAQQ19+1

TXA
PHA
JSRTT69
CLC
LDAQQ29
ADC#208

JSRTT27
LDA#14
STAXC
PLA
TAX
CLC
JSRpr2
JSRTT152

LDAQQ11
CMP#4
BNETT212
LDA#205
JSRTT214

BCCTT212
LDAQQ29
LDX#255
STXQQ17
JSRTT151

LDYQQ29
LDAQQ20,Y
STAP
LDAQQ24
STAQ
JSRGCASH
JSRMCASH

LDA#0
LDYQQ29
STAQQ20,Y
STAQQ17

.TT212 LDYQQ29
INY
CPY#17
BCSP%+5
JMPTT211
LDAQQ11
CMP#4
BNEP%+8
JSRdn2
JMPBAY2
RTS

.TT213\Invntry

LDA#8
JSRTT66
LDA#11
STAXC
LDA#164
JSRTT60
JSRNLIN4
JSRfwl

LDACRGO
CMP#26
BCCP%+7
LDA#&6B
JSRTT27
JMPTT210

.TT214 PHA
JSRTT162
PLA
.TT221 JSRTT27
LDA#225
JSRTT27

JSRTT217
ORA#32
CMP#&79
BEQTT218
LDA#&6E
JMPTT26
.TT218 JSRTT26
SEC
RTS

.TT16 TXA
PHA
DEY
TYA
EOR#255
PHA
JSRWSCAN
JSRTT103
PLA
STAQQ19+3

LDAQQ10
JSRTT123
LDAQQ19+4
STAQQ10
STAQQ19+1
PLA

STAQQ19+3
LDAQQ9
JSRTT123
LDAQQ19+4
STAQQ9
STAQQ19
.TT103

LDAQQ11
BEQTT180
BMITT105
LDAQQ9
STAQQ19
LDAQQ10
LSRA
STAQQ19+1
LDA#4
STAQQ19+2
JMPTT15

.TT123 STAQQ19+4
CLC
ADCQQ19+3
LDXQQ19+3
BMITT124
BCCTT125

RTS
.TT124 BCCTT180
.TT125 STAQQ19+4
.TT180 RTS

.TT105 LDAQQ9
SEC
SBCQQ0
CMP#38
BCCTT179
CMP#230
BCCTT180

.TT179 ASLA
ASLA
CLC
ADC#104
STAQQ19

LDAQQ10
SEC
SBCQQ1
CMP#38
BCCP%+6
CMP#220
BCCTT180

ASLA
CLC
ADC#90
STAQQ19+1
LDA#8
STAQQ19+2
JMPTT15

.TT23\ShrtSc

LDA#128
JSRTT66
LDA#7
STAXC
LDA#190
JSRNLIN3
JSRTT14
JSRTT103
JSRTT81

LDA#0
STAXX20
LDX#24
.EE3 STAINWK,X
DEX
BPLEE3

.TT182 LDAQQ15+3
SEC
SBCQQ0
BCSTT184
EOR#FF
ADC#1
.TT184 CMP#20
BCSTT187
LDAQQ15+1
SEC
SBCQQ1
BCSTT186
EOR#FF
ADC#1
.TT186 CMP#38
BCSTT187

LDAQQ15+3
SEC
SBCQQ0
ASLA
ASLA
ADC#104
STAXX12
LSRA
LSRA
LSRA
STAXC
INCXC
LDAQQ15+1
SEC
SBCQQ1
ASLA
ADC#90
STAK4
LSRA
LSRA
LSRA

TAY
LDXINWK,Y
BEQEE4
INY
LDXINWK,Y
BEQEE4
DEY
DEY
LDXINWK,Y
BNEee1
.EE4 STYYC
CPY#3
BCCTT187
DEX
STXINWK,Y

LDA#128
STAQQ17
JSRcpl
.ee1

\bigstars
LDA#0
STAK3+1
STAK4+1
STAK+1
LDAXX12
STAK3
LDAQQ15+5
AND#1
ADC#2
STAK
JSRFLFLLS
JSRSUN
JSRFLFLLS

.TT187 JSRTT20
INCXX20
BEQTT111-1
JMPTT182

.TT81 LDX#5
LDAQQ21,X
STAQQ15,X
DEX
BPLTT81+2
RTS

.TT111 JSRTT81
LDY#127
STYT
LDA#0
STAU

.TT130 LDAQQ15+3
SEC
SBCQQ9
BCSTT132
EOR#FF
ADC#1
.TT132 LSRA
STAS
LDAQQ15+1
SEC
SBCQQ10
BCSTT134
EOR#FF
ADC#1
.TT134 LSRA
CLC
ADCS
CMPT
BCSTT135

STAT
LDX#5
.TT136 LDAQQ15,X
STAQQ19,X
DEX
BPLTT136
.TT135

JSRTT20
INCU
BNETT130
LDX#5
.TT137 LDAQQ19,X
STAQQ15,X
DEX

BPLTT137
LDAQQ15+1
STAQQ10
LDAQQ15+3
STAQQ9

SEC
SBCQQ0
BCSTT139
EOR#FF
ADC#1
.TT139 JSRSQUA2
STAK+1
LDAP
STAK
LDAQQ10

SEC
SBCQQ1
BCSTT141
EOR#FF
ADC#1
.TT141 LSRA
JSRSQUA2
PHA
LDAP
CLC
ADCK

STAQ
PLA
ADCK+1
STAR
JSRLL5
LDAQ
ASLA
LDX#0
STXQQ8+1
ROLQQ8+1
ASLA
ROLQQ8+1
STAQQ8
JMPTT24

.hy6 JSRCLYNS
LDA#15
STAXC
JMPTT27

.hyp LDAQQ12
BNEhy6
LDAQQ22+1
BNEzZ+1
JSRCTRL
BMIGhy

JSRhm
LDAQQ8
ORAQQ8+1
BEQzZ+1
LDA#7
STAXC
LDA#23
STAYC
LDA#0
STAQQ17
LDA#189
JSRTT27
LDAQQ8+1
BNETT147
LDAQQ14
CMPQQ8
BCCTT147

LDA#&2D
JSRTT27
JSRcpl
.wW LDA#15
STAQQ22+1
STAQQ22
TAX
JMPee3\hy5 RTS

.Ghy
;JSRTT111       ; is in ELITED.TXT but not in ELITE SOURCE IMAGE
LDXGHYP
BEQhy5
INX
STXQQ8
STXQQ8+1
STXGHYP
STXFIST
JSRwW
LDX#5
INCGCNT
LDAGCNT
AND#7
STAGCNT
.G1 LDAQQ21,X
ASLA
ROLQQ21,X
DEX
BPLG1
\JSRDORND
.zZ LDA#&60
STAQQ9
STAQQ10
JSRTT110
LDA#116
JSRMESS
.jmp LDAQQ9
STAQQ0
LDAQQ10
STAQQ1
.hy5 RTS

.ee3 LDY#1
STYYC
DEY
STYXC
.pr6 CLC
.pr5 LDA#5
JMPTT11

.TT147 LDA#202
.prq JSRTT27
LDA#&3F
JMPTT27

.TT151\Pmk-A

PHA
STAQQ19+4
ASLA
ASLA
STAQQ19
LDA#1
STAXC
PLA
ADC#208

JSRTT27
LDA#14
STAXC
LDXQQ19
LDAQQ23+1,X
STAQQ19+1
LDAQQ26
ANDQQ23+3,X
CLC
ADCQQ23,X
STAQQ24
JSRTT152

JSRvar
LDAQQ19+1
BMITT155
LDAQQ24
ADCQQ19+3
JMPTT156

.TT155 LDAQQ24
SEC
SBCQQ19+3
.TT156 STAQQ24
STAP
LDA#0
JSRGC2

SEC
JSRpr5
LDYQQ19+4
LDA#5
LDXAVL,Y
STXQQ25

CLC
BEQTT172
JSRpr2+2
JMPTT152
.TT172 LDAXC
ADC#4
STAXC
LDA#&2D
BNETT162+2

.TT152 LDAQQ19+1
AND#96
BEQTT160
CMP#32
BEQTT161

JSRTT16a
.TT162 LDA#32
JMPTT27

.TT160 LDA#&74
JSRTT26
BCCTT162

.TT161 LDA#&6B
JSRTT26
.TT16a LDA#&67
JMPTT26

.TT163 LDA#17
STAXC
LDA#FF
BNETT162+2

.TT167\MktP

LDA#16
JSRTT66
LDA#5
STAXC
LDA#167
JSRNLIN3
LDA#3
STAYC
JSRTT163
LDA#0
STAQQ29
.TT168 LDX#128
STXQQ17
JSRTT151
INCYC

INCQQ29
LDAQQ29
CMP#17
BCCTT168
RTS

.var LDAQQ19+1
AND#31
LDYQQ28
STAQQ19+2
CLC
LDA#0
STAAVL+16
.TT153 DEY
BMITT154
ADCQQ19+2
JMPTT153
.TT154 STAQQ19+3
RTS

.hyp1 JSRTT111
JSRjmp
LDX#5
.TT112 LDAQQ15,X
STAQQ2,X
DEX
BPLTT112
INX
STXEV
LDAQQ3
STAQQ28
LDAQQ5
STAtek
LDAQQ4
STAgov
RTS

.GVL JSRDORND
STAQQ26
LDX#0
STXXX4
.hy9 LDAQQ23+1,X
STAQQ19+1
JSRvar
LDAQQ23+3,X
ANDQQ26
CLC
ADCQQ23+2,X
LDYQQ19+1
BMITT157
SEC
SBCQQ19+3
JMPTT158
.TT157 CLC
ADCQQ19+3
.TT158 BPLTT159
LDA#0
.TT159

LDYXX4
AND#63
STAAVL,Y
INY
TYA
STAXX4
ASLA
ASLA
TAX
CMP#63
BCChy9
.hyR RTS

.GTHG JSRZe
LDA#FF
STAINWK+32
LDA#THG
JSRNWSHP
LDA#TGL
JMPNWSHP

.ptg LSRCOK
SEC
ROLCOK

.MJP\LDA#1
JSRTT66-2
JSRLL164
JSRRES2
STYMJ
.MJP1 JSRGTHG
LDA#3
CMPMANY+THG
BCSMJP1
STANOSTM
LDX#0
JSRLOOK1
LDAQQ1
EOR#31
STAQQ1
RTS

.TT18\HSPC

LDAQQ14
SEC
SBCQQ8
STAQQ14
LDAQQ11
BNEee5
JSRTT66
JSRLL164
.ee5 JSRCTRL
ANDPATG
BMIptg
JSRDORND
CMP#253
BCSMJP\JSRTT111
JSRhyp1+3
JSRGVL
JSRRES2
JSRSOLAR

LDAQQ11
AND#63
BNEhyR
JSRTTX66
LDAQQ11
BNETT114
INCQQ11
.TT110 LDXQQ12
BEQNLUNCH
JSRLAUN
JSRRES2
JSRTT111
INCINWK+8
JSRSOS1
LDA#128
STAINWK+8
INCINWK+7
JSRNWSPS
LDA#12
STADELTA
JSRBAD
ORAFIST
STAFIST

.NLUNCH LDX#0
STXQQ12
JMPLOOK1
.TT114 BMITT115
JMPTT22
.TT115 JMPTT23

.LCASH STXT1
LDACASH+3
SEC
SBCT1
STACASH+3
STYT1
LDACASH+2
SBCT1
STACASH+2
LDACASH+1
SBC#0
STACASH+1
LDACASH
SBC#0
STACASH
BCSTT113

.MCASH TXA
CLC
ADCCASH+3
STACASH+3
TYA
ADCCASH+2
STACASH+2
LDACASH+1
ADC#0
STACASH+1
LDACASH
ADC#0
STACASH
CLC
.TT113 RTS

.GCASH JSRMULTU
.GC2 ASLP
ROLA
ASLP
ROLA
TAY
LDXP
RTS

.bay JMPBAY

.EQSHP JSRDIALS
LDA#32
JSRTT66
LDA#12
STAXC
LDA#207
JSRspc
LDA#185
JSRNLIN3
LDA#128
STAQQ17
INCYC
LDAtek
CLC
ADC#3
CMP#12
BCCP%+4
LDA#12
STAQ
STAQQ25
INCQ
LDA#70
SEC
SBCQQ14
ASLA
STAPRXS

LDX#1
.EQL1 STXXX13
JSRTT67
LDXXX13
CLC
JSRpr2
JSRTT162
LDAXX13
CLC
ADC#&68
JSRTT27
LDAXX13
JSRprx-3
SEC
LDA#25
STAXC
LDA#6
JSRTT11
LDXXX13
INX
CPXQ
BCCEQL1

JSRCLYNS
LDA#127
JSRprq
JSRgnum
beqbay
bcsbay
SBC#0
LDX#2
STXXC
INCYC
PHA
JSReq
PLA
BNEet0
STAMCNT
LDX#70
STXQQ14
.et0 CMP#1
BNEet1
LDXNOMSL
INX
LDY#&75
CPX#5
BCSpres

STXNOMSL
JSRmsblob
.et1 LDY#&6B
CMP#2
BNEet2
LDX#37
CPXCRGO
BEQpres
STXCRGO
.et2 CMP#3
BNEet3
INY
LDXECM
BNEpres
DECECM
.et3 CMP#4
BNEet4
JSRqv
LDA#4
LDYLASER,X
BEQed4
.ed7 LDY#187
BNEpres
.ed4 LDA#POW
STALASER,X
LDA#4
.et4

CMP#5
BNEet5
JSRqv
STXT1
LDA#5
LDYLASER,X
BEQed5
\BPLP%+4
BMIed7
LDA#4
JSRprx
JSRMCASH
.ed5 LDA#POW+128
LDXT1
STALASER,X
.et5

LDY#&6F
CMP#6
BNEet6
LDXBST
BEQed9
.pres STYK
JSRprx
JSRMCASH
LDAK
JSRspc
LDA#31
JSRTT27
.err JSRdn2
JMPBAY
.ed9 DECBST
.et6 INY
CMP#7
BNEet7
LDXESCP
BNEpres
DECESCP
.et7 INY
CMP#8
BNEet8
LDXBOMB
BNEpres
LDX#&7F
STXBOMB
.et8

INY
CMP#9
BNEetA
LDXENGY
BNEpres
INCENGY
.etA INY
CMP#10
BNEetB
LDXDKCMP
BNEpres
DECDKCMP
.etB
INY
CMP#11
BNEet9
LDXGHYP
BNEpres
DECGHYP
.et9 JSRdn
JMPEQSHP
.dn JSRTT162
LDA#119
JSRspc
.dn2 JSRBEEP
LDY#50
JMPDELAY

.eq JSRprx
JSRLCASH
BCSc
LDA#197
JSRprq
JMPerr
SEC
SBC#1
.prx ASLA
TAY
LDXPRXS,Y
LDAPRXS+1,Y
TAY
.c RTS

.qv LDY#16
STYYC
.qv1 LDX#12
STXXC
TYA
CLC
ADC#B-16
JSRspc
LDAYC
CLC
ADC#&50
JSRTT27
INCYC
LDYYC
CPY#20
BCCqv1
.qv3 JSRCLYNS
.qv2 LDA#175
JSRprq
JSRTT217
SEC
SBC#&30
CMP#4
BCSqv3
TAX
RTS

;IFZ>4OSCLI("S.ELTD "+STR$~W%+" "+STR$~O%+" "+STR$~L%+" "+STR$~H%)

PRINT "ELITE<D>"
PRINT "ASSEMBLE AT W%=", ~C_D%
PRINT "P%=",~P%
PRINT "CODE SIZE=", ~(P%-C_D%)
PRINT "EXECUTE AT L%=", ~L%
PRINT "RELOAD AT H%=", ~H_D%

PRINT "S.ELTD ",~C_D%," ",~P%," ",~L%," ",~H_D%
SAVE "output/ELTD.bin", C_D%, P%, L%

PRINT "D d,";

\************************************************
\* ELITE<E>
\************************************************

;H%=L%+P%-C%
;O%=W%
C_E%=P%
H_E%=L%+P%-C_A%

\[OPTZ

MAPCHAR '(', '('EOR&A4
MAPCHAR 'C', 'C'EOR&A4
MAPCHAR ')', ')'EOR&A4
MAPCHAR 'B', 'B'EOR&A4
MAPCHAR 'e', 'e'EOR&A4
MAPCHAR 'l', 'l'EOR&A4
MAPCHAR '/', '/'EOR&A4
MAPCHAR 'r', 'r'EOR&A4
MAPCHAR 'a', 'a'EOR&A4
MAPCHAR 'b', 'b'EOR&A4
MAPCHAR 'n', 'n'EOR&A4
MAPCHAR '1', '1'EOR&A4
MAPCHAR '9', '9'EOR&A4
MAPCHAR '8', '8'EOR&A4
MAPCHAR '4', '4'EOR&A4

.BDOLLAR
EQUS "(C)Bell/Braben1984"     ; TODO EOR &A4

MAPCHAR '(', '('
MAPCHAR 'C', 'C'
MAPCHAR ')', ')'
MAPCHAR 'B', 'B'
MAPCHAR 'e', 'e'
MAPCHAR 'l', 'l'
MAPCHAR '/', '/'
MAPCHAR 'r', 'r'
MAPCHAR 'a', 'a'
MAPCHAR 'b', 'b'
MAPCHAR 'n', 'n'
MAPCHAR '1', '1'
MAPCHAR '9', '9'
MAPCHAR '8', '8'
MAPCHAR '4', '4'

.cpl LDX#5
.TT53 LDAQQ15,X
STAQQ19,X
DEX
BPLTT53
LDY#3
BITQQ15
BVSP%+3
DEY
STYT
.TT55 LDAQQ15+5
AND#31
BEQP%+7
ORA#128
JSRTT27
JSRTT54
DECT
BPLTT55
LDX#5
.TT56 LDAQQ19,X
STAQQ15,X
DEX
BPLTT56
RTS

.cmn LDY#0
.QUL4 LDANA%,Y
CMP#13
BEQypl-1
JSRTT26
INY
BNEQUL4
RTS

.ypl LDAMJ
BNEcmn-1
JSRTT62
JSRcpl
.TT62 LDX#5
.TT78 LDAQQ15,X
LDYQQ2,X
STAQQ2,X
STYQQ15,X
DEX
BPLTT78
RTS

.tal CLC
LDXGCNT
INX
JMPpr2
.fwl LDA#105
JSRTT68
LDXQQ14
SEC
JSRpr2
LDA#195
JSRplf
.PCASH LDA#119
BNETT27

.csh LDX#3
.pc1 LDACASH,X
STAK,X
DEX
BPLpc1
LDA#9
STAU
SEC
JSRBPRNT
LDA#226
.plf JSRTT27
JMPTT67
.TT68 JSRTT27
.TT73 LDA#&3A

.TT27 TAX
BEQcsh
BMITT43
DEX
BEQtal
DEX
BEQypl
dex
bneP%+5
JMPcpl
dex
beqcmn
dex
beqfwl
dex
bneP%+7
LDA#128
STAQQ17
RTS
DEX
DEX
BNEP%+5
STXQQ17
RTS
dex
beqcrlf
CMP#&60
BCSex
CMP#14
BCCP%+6
CMP#32
BCCqw
LDXQQ17

BEQTT74
BMITT41
BITQQ17
BVSTT46
.TT42 CMP#65
BCCTT44
CMP#&5B
BCSTT44
ADC#32
.TT44 JMPTT26
.TT41 BITQQ17
BVSTT45
CMP#65
BCCTT74
PHA
TXA
ORA#64
STAQQ17
PLA
BNETT44

.qw ADC#114
BNEex
.crlf LDA#21
STAXC
BNETT73
.TT45 CPX#FF
BEQTT48
CMP#65
BCSTT42
.TT46 PHA
TXA
AND#191
STAQQ17
PLA
.TT74 JMPTT26
.TT43 CMP#160
BCSTT47
AND#127
ASLA
TAY
LDAQQ16,Y

JSRTT27
LDAQQ16+1,Y
CMP#63
BEQTT48
JMPTT27
.TT47 SBC#160
.ex TAX
LDA#(QQ18 MOD256)
STAV
LDA#(QQ18 DIV256)
STAV+1
LDY#0
TXA
BEQTT50

.TT51 LDA(V),Y
BEQTT49
INY
BNETT51
INCV+1
BNETT51
.TT49 INY
BNETT59
INCV+1
.TT59 DEX
BNETT51
.TT50

TYA
PHA
LDAV+1
PHA
LDA(V),Y
EOR#35

JSRTT27
PLA
STAV+1
PLA
TAY
INY
BNEP%+4
INCV+1
LDA(V),Y
BNETT50
.TT48 RTS

.EX2 LDAINWK+31
ORA#&A0
STAINWK+31
RTS

.DOEXP LDAINWK+31
AND#64
BEQP%+5
JSRPTCLS
LDAINWK+6
STAT
LDAINWK+7
CMP#&20
BCCP%+6
LDA#&FE
BNEyy
ASLT
ROLA
ASLT
ROLA
SEC
ROLA
.yy STAQ
LDY#1
LDA(XX19),Y
ADC#4
BCSEX2

STA(XX19),Y
JSRDVID4
LDAP
CMP#&1C
BCCP%+6
LDA#&FE
BNE LABEL_1
ASLR
ROLA
ASLR
ROLA
ASLR
ROLA
.LABEL_1 DEY
STA(XX19),Y
LDAINWK+31
AND#&BF
STAINWK+31
AND#8
BEQTT48

LDY#2
LDA(XX19),Y
TAY
.EXL1 LDAXX3-7,Y
STA(XX19),Y
DEY
CPY#6
BNEEXL1
LDAINWK+31
ORA#64
STAINWK+31

.PTCLS LDY#0
LDA(XX19),Y
STAQ
INY
LDA(XX19),Y
BPLP%+4
EOR#FF
LSRA
LSRA
LSRA
ORA#1
STAU
INY
LDA(XX19),Y
STATGT
LDARAND+1
PHA

LDY#6
.EXL5 LDX#3
.EXL3 INY
LDA(XX19),Y
STAK3,X
DEX
BPLEXL3
STYCNT
LDY#2
.EXL2 INY
LDA(XX19),Y
EORCNT
;STARAND-3,Y
STA&FFFD,Y
CPY#6
BNEEXL2
LDYU

.EXL4 JSRDORND2
STAZZ
LDAK3+1
STAR
LDAK3
JSREXS1
BNEEX11
CPX#2*Y-1
BCSEX11
STXY1
LDAK3+3
STAR
LDAK3+2
JSREXS1
BNEEX4
LDAY1
JSRPIXEL
.EX4 DEY
BPLEXL4
LDYCNT
CPYTGT
BCCEXL5

PLA
STARAND+1
LDAK%+6
STARAND+3
RTS
.EX11 JSRDORND2
JMPEX4

.EXS1 STAS
JSRDORND2
ROLA
BCSEX5
JSRFMLTU
ADCR
TAX
LDAS
ADC#0
RTS

.EX5 JSRFMLTU
STAT
LDAR
SBCT
TAX
LDAS
SBC#0
RTS

.SOS1 JSRmsblob
LDA#127
STAINWK+29
STAINWK+30
LDAtek
AND#2
ORA#128
JMPNWSHP

.SOLAR LSRFIST
JSRZINF
LDAQQ15+1
AND#7
ADC#6
LSRA
STAINWK+8
RORA
STAINWK+2
STAINWK+5

JSRSOS1
LDAQQ15+3
AND#7
ORA#129
STAINWK+8
LDAQQ15+5
AND#3
STAINWK+2
STAINWK+1
LDA#0
STAINWK+29
STAINWK+30
LDA#&81
JSRNWSHP

.NWSTARS LDAQQ11
\ORAMJ
BNEWPSHPS
.nWq LDYNOSTM
.SAL4 JSRDORND
ORA#8
STASZ,Y
STAZZ
JSRDORND
STASX,Y
STAX1
JSRDORND
STASY,Y
STAY1
JSRPIXEL2
DEY
BNESAL4

.WPSHPS LDX#0
.WSL1 LDAFRIN,X
BEQWS2
BMIWS1
STATYPE
JSRGINF
LDY#31

.WSL2 LDA(INF),Y
STAINWK,Y
DEY
BPLWSL2
STXXSAV
JSRSCAN
LDXXSAV
LDY#31
LDA(INF),Y
AND#&A7
STA(INF),Y
.WS1 INX
BNEWSL1
.WS2 LDX#FF
STXLSX2
STXLSY2

.FLFLLS LDY#2*Y-1
LDA#0
.SAL6 STALSO,Y
DEY
BNESAL6
DEY
STYLSX
RTS

.DET1 LDA#6
SEI
STA&FE00
STX&FE01
CLI
RTS

DEX
RTS
.SHD INX
BEQSHD-2
.DENGY DECENERGY
PHP
BNEP%+5
INCENERGY
PLP
RTS

.COMPAS JSRDOT
LDASSPR
BNESP1
JSRSPS1
JMPSP2
.SPS2 ASLA
TAX
LDA#0
RORA
TAY
LDA#20 \14
STAQ
TXA
JSRDVID4
LDXP

TYA
BMILL163
LDY#0
RTS
.LL163 LDY#FF
TXA
EOR#FF
TAX
INX
RTS

.SPS4 LDX#8
.SPL1 LDAK%+NI%,X
STAK3,X
DEX
BPLSPL1
JMPTAS2

.SP1 JSRSPS4
.SP2 LDAXX15
JSRSPS2
TXA
ADC#195\X-1
STACOMX
LDAXX15+1
JSRSPS2
STXT
LDA#204
SBCT
STACOMY

LDA#&F0
LDXXX15+2
BPLP%+4
LDA#FF
STACOMC

.DOT LDACOMY
STAY1
LDACOMX
STAX1
LDACOMC
STACOL
CMP#&F0
BNECPIX2
.CPIX4 JSRCPIX2
DECY1
.CPIX2 LDAY1

\.CPIX
TAY
LSRA
LSRA
LSRA
ORA#&60
STASCH
LDAX1
AND#&F8
STASC
TYA
AND#7
TAY
LDAX1
AND#6
LSRA
TAX
LDACTWOS,X
ANDCOL
EOR(SC),Y
STA(SC),Y

LDACTWOS+1,X
BPLCP1
LDASC
ADC#8
STASC
LDACTWOS+1,X
.CP1 ANDCOL
EOR(SC),Y
STA(SC),Y
RTS

.OOPS STAT
LDY#8
LDX#0
LDA(INF),Y
BMIOO1
LDAFSH
SBCT
BCCOO2
STAFSH
RTS
.OO2 \LDX#0
STXFSH
BCCOO3
.OO1 LDAASH
SBCT
BCCOO5
STAASH
RTS
.OO5 \LDX#0
STXASH
.OO3 ADCENERGY
STAENERGY
BEQP%+4
BCSP%+5
JMPDEATH
JSREXNO3
JMPOUCH

.SPS3 LDAK%+1,X
STAK3,X
LDAK%+2,X
TAY
AND#127
STAK3+1,X
TYA
AND#128
STAK3+2,X
RTS

.GINF TXA
ASLA
TAY
LDAUNIV,Y
STAINF
LDAUNIV+1,Y
STAINF+1
RTS

.NWSPS JSRSPBLB
LDX#1
STXINWK+32
DEX
STXINWK+30
\STXINWK+31
STXFRIN+1
DEX
STXINWK+29
LDX#10
JSRNwS1
JSRNwS1
JSRNwS1

LDA#(LSO MOD256)
STAINWK+33
LDA#(LSO DIV256)
STAINWK+34
LDA#SST

.NWSHP STAT
LDX#0
.NWL1 LDAFRIN,X
BEQNW1
INX
CPX#NOSH
BCCNWL1
.NW3 CLC
RTS

.NW1 JSRGINF
LDAT
BMINW2
ASLA
TAY
LDAXX21-2,Y
STAXX0
LDAXX21-1,Y
STAXX0+1
CPY#2*SST
BEQNW6
LDY#5
LDA(XX0),Y
STAT1
LDASLSP
SEC
SBCT1
STAINWK+33
LDASLSP+1
SBC#0
STAINWK+34

LDAINWK+33
\SEC
SBCINF
TAY
LDAINWK+34
SBCINF+1
BCCNW3+1
BNENW4
CPY#NI%
BCCNW3+1
.NW4

LDAINWK+33
STASLSP
LDAINWK+34
STASLSP+1
.NW6 LDY#14
LDA(XX0),Y
STAINWK+35
LDY#19
LDA(XX0),Y
AND#7
STAINWK+31

LDAT
.NW2 STAFRIN,X
TAX
BMIP%+5
INCMANY,X
LDY#(NI%-1)
.NWL3 LDAINWK,Y
STA(INF),Y
DEY
BPLNWL3
SEC
RTS

.NwS1 LDAINWK,X
EOR#128
STAINWK,X
INX
INX
RTS

.ABORT LDX#FF
.ABORT2 STXMSTG
LDXNOMSL
JSRMSBAR
STYMSAR
RTS

.ECBLB2 LDA#32
STAECMA
ASLA
JSRNOISE
.ECBLB LDA#7*8
\" <<120<"
LDX#(ECBT MOD256)
LDY#(ECBT DIV256)
BNEBULB-2

.SPBLB LDA#24*8
\"�<<128<"
LDX#(SPBT MOD256)
LDY#(SPBT DIV256)
.BULB STASC
STXP+1
STYP+2
LDA#&7D
JMPRREN

.ECBT EQUW&E0E0
EQUB&80
.SPBT EQUD&E080E0E0
EQUD&E0E020E0

.MSBAR TXA
ASLA
ASLA
ASLA
STAT
LDA#49\113
SBCT
STASC
LDA#&7E
STASCH
TYA
LDY#5
.MBL1 STA(SC),Y
DEY
BNEMBL1
RTS

.PROJ LDAINWK
STAP
LDAINWK+1
STAP+1
LDAINWK+2
JSRPLS6
BCSPL2-1
LDAK
ADC#X
STAK3
TXA
ADC#0
STAK3+1

LDAINWK+3
STAP
LDAINWK+4
STAP+1
LDAINWK+5
EOR#128
JSRPLS6
BCSPL2-1
LDAK
ADC#Y
STAK4
TXA
ADC#0
STAK4+1
CLC
RTS

.PL2 LDATYPE
LSRA
BCSP%+5
JMPWPLS2
JMPWPLS

.PLANET LDAINWK+8
BMIPL2
CMP#48
BCSPL2
ORAINWK+7
BEQPL2
JSRPROJ
BCSPL2

LDA#96
STAP+1
LDA#0
STAP
JSRDVID3B2
LDAK+1
BEQPL82
LDA#&F8
STAK
.PL82

LDATYPE
LSRA
BCCPL9
JMPSUN
.PL9 JSRWPLS2
JSRCIRCLE
BCSPL20
LDAK+1
BEQPL25
.PL20 RTS

.PL25 LDATYPE
CMP#&80
BNEPL26
LDAK
CMP#6
BCCPL20
LDAINWK+14
EOR#128
STAP
LDAINWK+20
JSRPLS4
LDX#9
JSRPLS1
STAK2
STYXX16
JSRPLS1
STAK2+1
STYXX16+1
LDX#15
JSRPLS5

JSRPLS2
LDAINWK+14
EOR#128
STAP
LDAINWK+26
JSRPLS4

LDX#21
JSRPLS5
JMPPLS2

.PL26\crtr
LDAINWK+20
BMIPL20

LDX#15
JSRPLS3
CLC
ADCK3
STAK3
TYA
ADCK3+1
STAK3+1
JSRPLS3
STAP
LDAK4
SEC
SBCP
STAK4
STYP
LDAK4+1
SBCP
STAK4+1

LDX#9
JSRPLS1
LSRA
STAK2
STYXX16
JSRPLS1
LSRA
STAK2+1
STYXX16+1

LDX#21
JSRPLS1
LSRA
STAK2+2
STYXX16+2
JSRPLS1
LSRA
STAK2+3
STYXX16+3

LDA#64
STATGT
LDA#0
STACNT2
JMPPLS22

.PLS1 LDAINWK,X
STAP
LDAINWK+1,X
AND#127
STAP+1
LDAINWK+1,X
AND#128

JSRDVID3B2
LDAK
LDYK+1
BEQP%+4
LDA#&FE
LDYK+3
INX
INX
RTS

.PLS2 LDA#31
STATGT
.PLS22 LDX#0
STXCNT
DEX
STXFLAG
.PLL4

LDACNT2
AND#31
TAX
LDASNE,X
STAQ
LDAK2+2
JSRFMLTU
STAR
LDAK2+3
JSRFMLTU
STAK
LDXCNT2
CPX#33
LDA#0
RORA
STAXX16+5

LDACNT2
CLC
ADC#16
AND#31
TAX
LDASNE,X
STAQ
LDAK2+1
JSRFMLTU
STAK+2
LDAK2
JSRFMLTU
STAP
LDACNT2
ADC#15
AND#63
CMP#33
LDA#0
RORA
STAXX16+4

LDAXX16+5
EORXX16+2
STAS
LDAXX16+4
EORXX16
JSRADD
STAT
BPLPL42
TXA
EOR#FF
CLC
ADC#1
TAX
LDAT
EOR#&7F
ADC#0
STAT
.PL42
TXA
ADCK3
STAK6
LDAT
ADCK3+1
STAK6+1

LDAK
STAR
LDAXX16+5
EORXX16+3
STAS
LDAK+2
STAP
LDAXX16+4
EORXX16+1
JSRADD
EOR#128
STAT
BPLPL43
TXA
EOR#FF
CLC
ADC#1
TAX
LDAT
EOR#&7F
ADC#0
STAT
.PL43

JSRBLINE
CMPTGT
BEQP%+4
BCSPL40
LDACNT2
CLC
ADCSTP
AND#63
STACNT2
JMPPLL4
.PL40 RTS

JMPWPLS
.PLF3 TXA
EOR#FF
CLC
ADC#1
TAX
.PLF17 LDA#FF
JMPPLF5

.SUN LDA#1
STALSX
JSRCHKON
BCSPLF3-3
LDA#0
LDXK
CPX#&60
ROLA
CPX#&28
ROLA
CPX#&10
ROLA

.PLF18 STACNT
LDA#2*Y-1
LDXP+2
BNEPLF2
CMPP+1
BCCPLF2
LDAP+1
BNEPLF2
LDA#1
.PLF2 STATGT

LDA#2*Y-1
SEC
SBCK4
TAX
LDA#0
SBCK4+1
BMIPLF3
BNEPLF4
INX
DEX
BEQPLF17
CPXK
BCCPLF5
.PLF4 LDXK
LDA#0
.PLF5 STXV
STAV+1

LDAK
JSRSQUA2
STAK2+1
LDAP
STAK2
LDY#2*Y-1
LDASUNX
STAYY
LDASUNX+1
STAYY+1
.PLFL2 CPYTGT
BEQPLFL
LDALSO,Y
BEQPLF13
JSRHLOIN2
.PLF13 DEY
BNEPLFL2

.PLFL LDAV
JSRSQUA2
STAT
LDAK2
SEC
SBCP
STAQ
LDAK2+1
SBCT
STAR
STYY1
JSRLL5
LDYY1
JSRDORND
ANDCNT
CLC
ADCQ
BCCPLF44
LDA#FF
.PLF44

LDXLSO,Y
STALSO,Y
BEQPLF11
LDASUNX
STAYY
LDASUNX+1
STAYY+1
TXA
JSREDGES
LDAX1
STAXX
LDAX2
STAXX+1

LDAK3
STAYY
LDAK3+1
STAYY+1
LDALSO,Y
JSREDGES
BCSPLF23
LDAX2
LDXXX
STXX2
STAXX
JSRHLOIN
.PLF23 LDAXX
STAX1
LDAXX+1
STAX2
.PLF16 JSRHLOIN
.PLF6

DEY
BEQPLF8
LDAV+1
BNEPLF10
DECV
BNEPLFL
DECV+1
.PLFLS JMPPLFL

.PLF11 LDXK3
STXYY
LDXK3+1
STXYY+1
JSREDGES
BCCPLF16
LDA#0
STALSO,Y
BEQPLF6

.PLF10 LDXV
INX
STXV
CPXK
BCCPLFLS
BEQPLFLS
LDASUNX
STAYY
LDASUNX+1
STAYY+1
.PLFL3 LDALSO,Y
BEQPLF9
JSRHLOIN2

.PLF9 DEY
BNEPLFL3
.PLF8 CLC
LDAK3
STASUNX
LDAK3+1
STASUNX+1
.RTS2 RTS

.CIRCLE JSRCHKON
BCSRTS2

LDA#0
STALSX2

LDXK
LDA#8
CPX#8
BCCPL89
LSRA
CPX#60
BCCPL89
LSRA
.PL89 STASTP
.CIRCLE2 LDX#FF
STXFLAG
INX
STXCNT
.PLL3

LDACNT
JSRFMLTU2
LDX#0
STXT
LDXCNT
CPX#33
BCCPL37
EOR#FF
ADC#0
TAX
LDA#FF
ADC#0
STAT
TXA
CLC

.PL37 ADCK3
STAK6
LDAK3+1
ADCT
STAK6+1

LDACNT
CLC
ADC#16
JSRFMLTU2
TAX
LDA#0
STAT
LDACNT
ADC#15
AND#63
CMP#33
BCCPL38
TXA
EOR#FF
ADC#0
TAX
LDA#FF
ADC#0
STAT
CLC

.PL38 JSRBLINE
CMP#65
BCSP%+5
JMPPLL3
CLC
RTS

.WPLS2 LDYLSX2
BNEWP1
.WPL1 CPYLSP
BCSWP1
LDALSY2,Y
CMP#FF
BEQWP2
STAY2
LDALSX2,Y
STAX2
JSRLOIN
INY
LDASWAP
BNEWPL1

LDAX2
STAX1
LDAY2
STAY1
JMPWPL1
.WP2 INY
LDALSX2,Y
STAX1
LDALSY2,Y
STAY1
INY
JMPWPL1
.WP1 LDA#1
STALSP
LDA#FF
STALSX2
RTS

.WPLS LDALSX
BMIWPLS-1
LDASUNX
STAYY
LDASUNX+1
STAYY+1
LDY#2*Y-1
.WPL2 LDALSO,Y
BEQP%+5
JSRHLOIN2
DEY
BNEWPL2
DEY
STYLSX
RTS

.EDGES STAT
CLC
ADCYY
STAX2
LDAYY+1
ADC#0
BMIED1
BEQP%+6
LDA#254
STAX2

LDAYY
SEC
SBCT
STAX1
LDAYY+1
SBC#0
BNEED3
CLC
RTS

.ED3 BPLED1
LDA#2
STAX1
CLC
RTS
.ED1 LDA#0
STALSO,Y
SEC
RTS

.CHKON LDAK3
CLC
ADCK
LDAK3+1
ADC#0
BMIPL21
LDAK3
SEC
SBCK
LDAK3+1
SBC#0
BMIPL31
BNEPL21
.PL31

LDAK4
CLC
ADCK
STAP+1
LDAK4+1
ADC#0
BMIPL21
STAP+2
LDAK4
SEC
SBCK
TAX
LDAK4+1
SBC#0
BMIPL44
BNEPL21
CPX#2*Y-1
RTS
.PL21 SEC
RTS

.PLS3 JSRPLS1
STAP
LDA#222
STAQ
STXU
JSRMULTU
LDXU
LDYK+3
BPLPL12
EOR#FF
CLC
ADC#1
BEQPL12
LDY#FF
RTS
.PL12 LDY#0
RTS

.PLS4 STAQ
JSRARCTAN
LDXINWK+14
BMIP%+4
EOR#128
LSRA
LSRA
STACNT2
RTS

.PLS5 JSRPLS1
STAK2+2
STYXX16+2
JSRPLS1
STAK2+3
STYXX16+3
RTS

.PLS6 JSRDVID3B2
LDAK+3
AND#127
ORAK+2
BNEPL21
LDXK+1
CPX#4
BCSPL6
LDAK+3
\CLC
BPLPL6
LDAK
EOR#FF
ADC#1
STAK
TXA
EOR#FF
ADC#0
TAX
.PL44 CLC
.PL6 RTS

.TT17 JSRDOKEY
LDAJSTK
BEQTJ1
LDAJSTX
EOR#FF
JSRTJS1
TYA
TAX

LDAJSTY
.TJS1 TAY
LDA#0
CPY#&10
SBC#0
\CPY#&20SBC#0
CPY#&40
SBC#0
CPY#&C0
ADC#0
CPY#&E0
ADC#0
\CPY#&F0ADC#0

TAY
LDAKL
RTS

.TJ1 LDAKL
LDX#0
LDY#0
CMP#&19
BNEP%+3
DEX
CMP#&79
BNEP%+3
INX
CMP#&39
BNEP%+3
INY
CMP#&29
BNEP%+3
DEY
RTS

.ping LDX#1
.pl1 LDAQQ0,X
STAQQ9,X
DEX
BPLpl1
RTS

;IFZ>4OSCLI("S.ELTE "+STR$~W%+" "+STR$~O%+" "+STR$~L%+" "+STR$~H%)

PRINT "ELITE<E>"
PRINT "ASSEMBLE AT W%=", ~C_E%
PRINT "P%=",~P%
PRINT "CODE SIZE=", ~(P%-C_E%)
PRINT "EXECUTE AT L%=", ~L%
PRINT "RELOAD AT H%=", ~H_E%

PRINT "S.ELTE ",~C_E%," ",~P%," ",~L%," ",~H_E%
SAVE "output/ELTE.bin", C_E%, P%, L%

PRINT "E e,";

\************************************************
\* ELITE<F>
\************************************************

;H%=L%+P%-C%
;O%=W%
C_F%=P%
H_F%=L%+P%-C_A%

\[OPTZ

.KS3 LDAP
STASLSP
LDAP+1
STASLSP+1
RTS
.KS1 LDXXSAV
JSRKILLSHP
LDXXSAV
JMPMAL1

.KS4 JSRZINF
JSRFLFLLS
STAFRIN+1
STASSPR
JSRSPBLB
LDA#6
STAINWK+5
LDA#&81
JMPNWSHP

.KS2 LDX#FF
.KSL4 INX
LDAFRIN,X
BEQKS3
CMP#MSL
BNEKSL4
TXA
ASLA
TAY
LDAUNIV,Y
STASC
LDAUNIV+1,Y
STASC+1

LDY#32
LDA(SC),Y
BPLKSL4
AND#&7F
LSRA
CMPXX4
BCCKSL4
BEQKS6
SBC#1
ASLA
ORA#128
STA(SC),Y
BNEKSL4
.KS6 LDA#0
STA(SC),Y
BEQKSL4

.KILLSHP STXXX4
;CPXMSTG
LDA MSTG            ; NOT IN ELITEF.TXT but is in ELITE SOURCE IMAGE
CMP XX4             ; NOT IN ELITEF.TXT but is in ELITE SOURCE IMAGE
BNEKS5 \<<**
LDY#&EE
JSRABORT
LDA#200
JSRMESS
.KS5 LDYXX4
LDXFRIN,Y
CPX#SST
BEQKS4
DECMANY,X
LDXXX4

LDY#5
LDA(XX0),Y
LDY#33
CLC
ADC(INF),Y
STAP
INY
LDA(INF),Y
ADC#0
STAP+1

.KSL1 INX
LDAFRIN,X
STAFRIN-1,X
BEQKS2
ASLA
TAY
LDAXX21-2,Y
STASC
LDAXX21-1,Y
STASC+1
LDY#5
LDA(SC),Y
STAT
LDAP
SEC
SBCT
STAP
LDAP+1
SBC#0
STAP+1

TXA
ASLA
TAY
LDAUNIV,Y
STASC
LDAUNIV+1,Y
STASC+1
LDY#35
LDA(SC),Y
STA(INF),Y
DEY

LDA(SC),Y
STAK+1
LDAP+1
STA(INF),Y
DEY
LDA(SC),Y
STAK
LDAP
STA(INF),Y
DEY
.KSL2 LDA(SC),Y
STA(INF),Y
DEY
BPLKSL2
LDASC
STAINF
LDASC+1
STAINF+1

LDYT
.KSL3 DEY
LDA(K),Y
STA(P),Y
TYA
BNEKSL3
BEQKSL1

.SFX EQUS &12,&01,&00,&10   ;FNS("12010010")
EQUS &12,&02,&2C,&08    ;FNS("12022C08")
EQUS &11,&03,&F0,&18    ;FNS("1103F018")
EQUS &10,&F1,&07,&1A    ;FNS("10F1071A")

EQUS &03,&F1,&BC,&01    ;FNS("03F1BC01")
EQUS &13,&F4,&0C,&08    ;FNS("13F40C08")
EQUS &10,&F1,&06,&0C    ;FNS("10F1060C")
EQUS &10,&02,&60,&10    ;FNS("10026010") HYP
EQUS &13,&04,&C2,&FF    ;FNS("1304C2FF")
EQUS &13,&00,&00,&00    ;FNS("13000000")

.RESET \"�<<<<"
JSRZERO
LDX#6
.SAL3 STABETA,X
DEX
BPLSAL3
STXQQ12
.RES4 LDA#FF
LDX#2
.REL5 STAFSH,X
DEX
BPLREL5

.RES2 LDA#NOST
STANOSTM
LDX#FF
STXLSX2
STXLSY2
STXMSTG
LDA#128
STAJSTY
STAALP2
STABET2
ASLA
STAALP2+1
STABET2+1
STAMCNT
LDA#3
STADELTA
STAALPHA
STAALP1

LDASSPR
BEQP%+5
JSRSPBLB
LDAECMA
BEQyu
JSRECMOF
.yu JSRWPSHPS
JSRZERO
LDA#(LS%MOD256)
STASLSP
LDA#(LS%DIV256)
STASLSP+1
JSRDIALS

.ZINF LDY#NI%-1
LDA#0
.ZI1 STAINWK,Y
DEY
BPLZI1
LDA#96
STAINWK+18
STAINWK+22
ORA#128
STAINWK+14
RTS

.msblob LDX#4
.ss CPXNOMSL
BEQSAL8
LDY#0
JSRMSBAR
DEX
BNEss
RTS
.SAL8 LDY#&EE
JSRMSBAR
DEX
BNESAL8
RTS

.me2 LDAMCH
JSRMESS
LDA#0
STADLY
JMPme3

.Ze JSRZINF
JSRDORND
STAT1
AND#128
STAINWK+2
TXA
AND#128
STAINWK+5
LDA#32
STAINWK+1
STAINWK+4
STAINWK+7
TXA
CMP#245
ROLA
ORA#&C0
STAINWK+32

.DORND2 CLC
.DORND LDARAND
ROLA
TAX
ADCRAND+2
STARAND
STXRAND+2
LDARAND+1
TAX
ADCRAND+3
STARAND+1
STXRAND+3
RTS

.MTT4 LSRA
STAINWK+32
STAINWK+29
ROLINWK+31
AND#31
ORA#16
STAINWK+27
LDA#CYL
JSRNWSHP

.TT100 JSRM%
DECDLY
BEQme2
BPLme3
INCDLY
.me3 DECMCNT
BEQP%+5
.ytq JMPMLOOP
LDAMJ
BNEytq

JSRDORND
CMP#35
BCSMTT1
LDAMANY+AST
CMP#3
BCSMTT1
JSRZINF
LDA#38
STAINWK+7
JSRDORND
STAINWK
STXINWK+3
AND#128
STAINWK+2
TXA
AND#128
STAINWK+5
ROLINWK+1
ROLINWK+1

JSRDORND
BVSMTT4
ORA#&6F
STAINWK+29
LDASSPR
BNEMTT1
TXA
BCSMTT2
AND#31
ORA#16
STAINWK+27
BCCMTT3

.MTT2 ORA#127
STAINWK+30
.MTT3 JSRDORND
CMP#5
LDA#AST
BCSP%+4
LDA#OIL
JSRNWSHP

.MTT1

LDASSPR
BNEMLOOP
JSRBAD
ASLA
LDXMANY+COPS
BEQP%+5
ORAFIST
STAT
JSRZe
CMPT
BCSP%+7
LDA#COPS
JSRNWSHP
LDAMANY+COPS
BNEMLOOP
DECEV
BPLMLOOP
INCEV
JSRDORND
LDYgov
BEQ LABEL_2
CMP#90
BCSMLOOP
AND#7
CMPgov
BCCMLOOP
.LABEL_2

JSRZe
CMP#200
BCSmt1
INCEV
AND#3
ADC#3
TAY
TXA
CMP#200
ROLA
ORA#&C0
CPY#6
BEQtha
STAINWK+32
TYA
JSRNWSHP
.mj1 JMPMLOOP
.mt1 AND#3
STAEV
STAXX13
.mt3 JSRDORND
AND#3
ORA#1
JSRNWSHP

DECXX13
BPLmt3
.MLOOP LDA#1
STAVIA+&E
LDX#FF
TXS
LDXGNTMP
BEQEE20
DECGNTMP
.EE20 JSRDIALS
LDAQQ11
BEQP%+11
ANDPATG
LSRA
BCSP%+5
JSRDELAY-5

JSRTT17
.FRCE JSRTT102
LDAQQ12
BNEMLOOP
JMPTT100

.tha JSRDORND
CMP#200
BCCP%+5
JSRGTHG
JMPMLOOP

.TT102 CMP#f8
BNEP%+5
JMPSTATUS
CMP#f4
BNEP%+5
JMPTT22
CMP#f5
BNEP%+5
JMPTT23
CMP#f6
BNETT92
JSRTT111
JMPTT25
.TT92 CMP#f9
BNEP%+5
JMPTT213
CMP#f7
BNEP%+5
JMPTT167
CMP#f0
BNEfvw
JMPTT110
.fvw BITQQ12

BPLINSP
CMP#f3
BNEP%+5
JMPEQSHP
CMP#f1
BNEP%+5
JMPTT219
CMP#&47
BNEP%+5
JMPSVE

CMP#f2
BNE LABEL_3
JMPTT208
.INSP CMP#&71
BCC LABEL_3
CMP#&74
BCS LABEL_3
AND#3
TAX
JMPLOOK1
.LABEL_3 CMP#&54
BNEP%+5
JMPhyp
CMP#&32
BEQT95
STAT1
LDAQQ11
AND#192
BEQTT107
LDAQQ22+1
BNETT107
LDAT1
CMP#&36
BNEee2
JSRTT103
JSRping

JSRTT103
.ee2 JSRTT16
.TT107
LDAQQ22+1
BEQt95
DECQQ22
BNEt95
LDXQQ22+1
DEX
JSRee3
LDA#5
STAQQ22
LDXQQ22+1
JSRee3
DECQQ22+1
BNEt95
JMPTT18
.t95 RTS

.T95 LDAQQ11
AND#192
BEQt95
JSRhm
STAQQ17
JSRcpl
LDA#128
STAQQ17
LDA#1
STAXC
INCYC
JMPTT146

.BAD LDAQQ20+3
CLC
ADCQQ20+6
ASLA
ADCQQ20+10
RTS

.FAROF LDA#&E0
.FAROF2 CMPINWK+1
BCCMA34
CMPINWK+4
BCCMA34
CMPINWK+7
.MA34 RTS
.MAS4 ORAINWK+1
ORAINWK+4
ORAINWK+7
RTS

.DEATH JSREXNO3
JSRRES2
ASLDELTA
ASLDELTA
LDX#24
JSRDET1
JSRTT66
JSRBOX
JSRnWq
LDA#12
STAYC
STAXC
LDA#146
JSRex
.D1 JSRZe
LSRA
LSRA
STAINWK
LDY#0
STYQQ11
STYINWK+1
STYINWK+4
STYINWK+7
STYINWK+32
DEY
STYMCNT
STYLASCT
EOR#42

STAINWK+3
ORA#80
STAINWK+6
TXA
AND#&8F
STAINWK+29

RORA
AND#&87
STAINWK+30
PHP
LDX#OIL
JSRfq1
PLP
LDA#0
RORA
LDY#31
STA(INF),Y
LDAFRIN+3
BEQD1
JSRU%
STADELTA
.D2 JSRM%
LDALASCT
BNED2
LDX#31
JSRDET1
.DEATH2 JSRRES2

.TT170 LDX#FF
TXS

.BR1 LDX#3
STXXC
JSRFX200
LDX#CYL
LDA#128
JSRTITLE
CMP#&44
BNEQU5
\BR1 LDX#3STXXCJSRFX200LDA#1JSRTT66JSRFLKB

\LDA#14JSRTT214BCCQU5
JSRGTNME
JSRLOD
JSRTRNME
JSRTTX66

.QU5 \JSRTTX66
LDX#NT%
.QUL1 LDANA%+7,X
STATP-1,X
DEX
BNEQUL1
STXQQ11
JSRCHECK
CMPCHK
BNEP%-6
EOR#&A9
TAX
LDACOK
CPXCHK2
BEQtZ
ORA#128
.tZ ORA#2
STACOK
JSRmsblob
LDA#147
LDX#3
JSRTITLE
JSRping
JSRhyp1

.BAY LDA#FF
STAQQ12
LDA#f8
JMPFRCE

.TITLE PHA
STXTYPE
JSRRESET
LDA#1
JSRTT66
DECQQ11
LDA#96
STAINWK+14

\LSRA
STAINWK+7
LDX#127
STXINWK+29
STXINWK+30
INX
STXQQ17

LDATYPE
JSRNWSHP

LDY#6
STYXC
JSRDELAY
LDA#30
JSRplf
LDY#6
STYXC
INCYC
LDAPATG
BEQawe
LDA#254
JSRTT27
.awe JSRCLYNS
STYDELTA
STYJSTK
PLA
JSRex
LDA#148
LDX#7
STXXC
JSRex

.TLL2 LDAINWK+7
CMP#1
BEQTL1
DECINWK+7
.TL1 JSRMVEIT
LDA#128
STAINWK+6
ASLA
STAINWK
STAINWK+3
JSRLL9
DECMCNT
LDA&FE40
AND#16
\TAX
BEQTL2
JSRRDKEY
BEQTLL2
RTS
.TL2 DECJSTK
RTS

.CHECK LDX#NT%-2
CLC
TXA
.QUL2 ADCNA%+7,X
EORNA%+8,X
DEX
BNEQUL2
RTS

.TRNME LDX#7
.GTL1 LDAINWK,X
STANA%,X
DEX
BPLGTL1
.TR1 LDX#7
.GTL2 LDANA%,X
STAINWK,X
DEX
BPLGTL2
RTS

.GTNME LDA#1
JSRTT66
LDA#123
JSRTT27
JSRDEL8
LDA#&81
STAVIA+&E
LDA#15
TAX
JSROSBYTE
LDX#(RLINE MOD256)
LDY#(RLINE DIV256)
LDA#0
JSROSWORD\LDA#1STAVIA+&E
BCSTR1
TYA
BEQTR1
JMPTT67

.RLINE EQUWINWK
EQUB7
EQUB33
EQUB&7A

.ZERO LDX#&D
.ZEL JSRZES1
DEX
CPX#9
BNEZEL

.ZES1 LDY#0
STYSC
.ZES2 LDA#0
STXSC+1
.ZEL1 STA(SC),Y
INY
BNEZEL1
RTS

.SVE JSRGTNME
JSRTRNME
JSRZERO
LSRSVC
LDX#NT%
.SVL1 LDATP,X
STA&B00,X
STANA%+8,X
DEX
BPLSVL1
JSRCHECK
STACHK
PHA
ORA#128
STAK
EORCOK
STAK+2
EORCASH+2
STAK+1
EOR#&5A
EORTALLY+1
STAK+3
JSRBPRNT
JSRTT67
JSRTT67
PLA
STA&B00+NT%
EOR#&A9

STACHK2
STA&AFF+NT%
LDY#&B
STY&C0B
INY
STY&C0F

LDA#&81
STAVIA+&E
INCsvn
LDA#0
JSRQUS1
LDX#0\STXVIA+&EDEX
STXsvn
JMPBAY

.QUS1 LDX#INWK
STX&C00
LDX#0
JMPOSFILE

.LOD LDX#2
JSRFX200
JSRZERO
LDY#&B
STY&C03
INC&C0B
INY
LDA#FF
JSRQUS1
LDA&B00
BMISPS1+1
LDX#NT%
.LOL1 LDA&B00,X
STANA%+8,X
DEX
BPLLOL1
LDX#3

.FX200\MOS
LDY#0
LDA#200
JMPOSBYTE

RTS
.SPS1 LDX#0
JSRSPS3
LDX#3
JSRSPS3
LDX#6
JSRSPS3

.TAS2 LDAK3
ORAK3+3
ORAK3+6
ORA#1
STAK3+9
LDAK3+1
ORAK3+4
ORAK3+7

.TAL2 ASLK3+9
ROLA
BCSTA2
ASLK3
ROLK3+1
ASLK3+3
ROLK3+4
ASLK3+6
ROLK3+7
BCCTAL2

.TA2 LDAK3+1
LSRA
ORAK3+2
STAXX15
LDAK3+4
LSRA
ORAK3+5
STAXX15+1
LDAK3+7
LSRA
ORAK3+8
STAXX15+2

.NORM

LDAXX15
JSRSQUA
STAR
LDAP
STAQ
LDAXX15+1
JSRSQUA
STAT
LDAP
ADCQ
STAQ
LDAT
ADCR
STAR
LDAXX15+2
JSRSQUA
STAT
LDAP
ADCQ
STAQ
LDAT
ADCR
STAR

JSRLL5

LDAXX15
JSRTIS2
STAXX15 \*96/Q

LDAXX15+1
JSRTIS2
STAXX15+1

LDAXX15+2
JSRTIS2
STAXX15+2
.NO1 RTS

.RDKEY \OSBYTE7A
LDX#16
.Rd1 JSRDKS4
BMIRd2
INX
BPLRd1
TXA
.Rd2 EOR#128
TAX
RTS

.ECMOF LDA#0
STAECMA
STAECMP
JSRECBLB
LDA#72
BNENOISE

.EXNO3 LDA#16
JSRNOISE
LDA#24
BNENOISE

.SFRMIS LDX#MSL
JSRSFS1-2
BCCNO1
LDA#&78
JSRMESS
LDA#48
BNENOISE

.EXNO2 INCTALLY
BNEEXNO-2
INCTALLY+1
LDA#101
JSRMESS
LDX#7 \15
.EXNO STXT
LDA#24
JSRNOS1
LDAINWK+7
LSRA
LSRA
ANDT
ORA#&F1
STAXX16+2
JSRNO3
LDA#16

EQUB&2C
.BEEP LDA#32

.NOISE JSRNOS1
.NO3 LDXDNOIZ
BNENO1
LDX#(XX16 MOD256)
LDY#(XX16 DIV256)
LDA#7
JMPOSWORD

.NOS1 LSRA
ADC#3
TAY
LDX#7
.NOL1 LDA#0
STAXX16,X
DEX
LDASFX,Y
STAXX16,X
DEY
DEX
BPLNOL1

.KYTB RTS
EQUB&E8
EQUB&E2
EQUB&E6
EQUB&E7
EQUB&C2
EQUB&D1
EQUB&C1
EQUD&35237060
EQUW&2265
EQUB&45
EQUB&52 \? <>XSA.FBRLtabescTUMEJC

.DKS1 LDXKYTB,Y
JSRDKS4
BPLDKS2-1
LDX#FF
STXKL,Y
RTS

.CTRL LDX#1
.DKS4 LDA#3
SEI
STA&FE40
LDA#&7F
STA&FE43
STX&FE4F
LDX&FE4F
LDA#&B
STA&FE40
CLI
TXA

RTS
.DKS2 LDA#&80
JSROSBYTE
TYA
EORJSTE

RTS
.DKS3 STYT
CPXT
BNEDk3
LDADAMP-&40,X
EOR#FF
STADAMP-&40,X
JSRBELL
JSRDELAY
LDYT
.Dk3 RTS

.DKJ1 LDY#1
JSRDKS1
INY
JSRDKS1

LDA&FE40
TAX
AND#16
EOR#16
STAKL+7
LDX#1
JSRDKS2
ORA#1
STAJSTX
LDX#2
JSRDKS2
EORJSTGY
STAJSTY
JMPDK4

.U% LDA#0
LDY#15
.DKL3 STAKL,Y
DEY
BNEDKL3
RTS

.DOKEY JSRU%
LDAJSTK
BNEDKJ1

LDY#7
.DKL2 JSRDKS1
DEY
BNEDKL2

LDXJSTX
LDA#7
LDYKL+3
BEQP%+5
JSRBUMP2
LDYKL+4
BEQP%+5
JSRREDU2
STXJSTX

ASLA
LDXJSTY
LDYKL+5
BEQP%+5
JSRREDU2
LDYKL+6
BEQP%+5
JSRBUMP2
STXJSTY

.DK4 JSRRDKEY
STXKL
CPX#&69
BNEDK2
.FREEZE JSRWSCAN
JSRRDKEY
CPX#&51
BNEDK6
LDA#0
STADNOIZ

.DK6 LDY#&40
.DKL4 JSRDKS3
INY
CPY#&47
BNEDKL4
.DK55 CPX#&10
BNEDK7
STXDNOIZ
.DK7 CPX#&70
BNEP%+5
JMPDEATH2
CPX#&59
BNEFREEZE
.DK2 LDAQQ11
BNEDK5
LDY#15
LDA#FF

.DKL1 LDXKYTB,Y
CPXKL
BNEDK1
STAKL,Y
.DK1 DEY
CPY#7
BNEDKL1

.DK5 RTS

.TT217 STYYSAV
.t JSRDELAY-5
JSRRDKEY
BNEt
.t2 JSRRDKEY
BEQt2
TAY
LDA(TRTB%),Y
LDYYSAV
TAX
.out RTS

.me1 STXDLY
PHA
LDAMCH
JSRmes9
PLA
EQUB&2C
.ou2 lda#108
EQUB&2C
.ou3 lda#111

.MESS LDX#0
STXQQ17
LDY#9
STYXC
LDY#22
STYYC
CPXDLY
BNEme1
STYDLY
STAMCH
.mes9 JSRTT27
LSRde
BCCout
LDA#253
JMPTT27

.OUCH JSRDORND
BMIout
CPX#22
BCSout
LDAQQ20,X
BEQout
LDADLY
BNEout
LDY#3
STYde
STAQQ20,X
CPX#17
BCSou1
TXA
ADC#208
BNEMESS
.ou1

BEQou2
CPX#18
BEQou3
TXA
ADC#113-20
BNEMESS

.QQ16 EQUS"ALLEXEGEZACEBISOUSESARMAINDIREA?ERATENBERALAVETIEDORQUANTEISRION"

.QQ23\Prxs
EQUD&1068213
EQUD&30A8114
EQUD&7028341\Food

EQUD&1FE28528
EQUD&FFB8553
EQUD&33608C4
EQUD &78081DEB \slvs..

EQUD&3380E9A
EQUD&7280675
EQUD&1F11014E
EQUD&71D0D7C \comps

EQUD&3FDC89B0
EQUD&03358120
EQUD&742A161
EQUD&1F37A2AB \pltnm

EQUD&FFAC12D
EQUD&7C00F35 \Gms.

.TI2 TYA
LDY#2
JSRTIS3
STAINWK+20\Uz=-(FxUx+FyUy)/Fz
JMPTI3

.TI1 TAX
LDAXX15+1
AND#&60
BEQTI2
LDA#2
JSRTIS3
STAINWK+18
JMPTI3

.TIDY LDAINWK+10
STAXX15
LDAINWK+12
STAXX15+1
LDAINWK+14
STAXX15+2
JSRNORM
LDAXX15
STAINWK+10
LDAXX15+1
STAINWK+12
LDAXX15+2
STAINWK+14

LDY#4
LDAXX15
AND#&60
BEQTI1
LDX#2
LDA#0
JSRTIS3
STAINWK+16

.TI3 LDAINWK+16
STAXX15
LDAINWK+18
STAXX15+1
LDAINWK+20
STAXX15+2
JSRNORM
LDAXX15
STAINWK+16
LDAXX15+1
STAINWK+18
LDAXX15+2
STAINWK+20

LDAINWK+12
STAQ
LDAINWK+20
JSRMULT12
LDXINWK+14
LDAINWK+18
JSRTIS1
EOR#128
STAINWK+22

LDAINWK+16
JSRMULT12
LDXINWK+10
LDAINWK+20
JSRTIS1
EOR#128
STAINWK+24

LDAINWK+18
JSRMULT12
LDXINWK+12
LDAINWK+16
JSRTIS1
EOR#128
STAINWK+26 \FxU/96(LHS)

LDA#0
LDX#14
.TIL1 STAINWK+9,X
DEX
DEX
BPLTIL1
RTS

.TIS2 TAY
AND#127
CMPQ
BCSTI4
LDX#254
STXT
.TIL2 ASLA
CMPQ
BCCP%+4
SBCQ
ROLT
BCSTIL2
LDAT

LSRA
LSRA
STAT
LSRA
ADCT
STAT
TYA
AND#128
ORAT
RTS
.TI4 TYA
AND#128
ORA#96
RTS

.TIS3 STAP+2
LDAINWK+10,X
STAQ
LDAINWK+16,X
JSRMULT12
LDXINWK+10,Y
STXQ
LDAINWK+16,Y
JSRMAD

STXP
LDYP+2
LDXINWK+10,Y
STXQ
EOR#128

.DVIDT\A=AP/Q
STAP+1
EORQ
AND#128
STAT
LDA#0
LDX#16
ASLP
ROLP+1
ASLQ
LSRQ
.DVL2 ROLA
CMPQ
BCCP%+4
SBCQ
ROLP
ROLP+1
DEX
BNEDVL2
LDAP
ORAT
RTS


;OSCLI("S.ELTF "+STR$~W%+" "+STR$~O%+" "+STR$~L%+" "+STR$~H%)

PRINT "ELITE<F>"
PRINT "ASSEMBLE AT W%=", ~C_F%
PRINT "P%=",~P%
PRINT "CODE SIZE=", ~(P%-C_F%)
PRINT "EXECUTE AT L%=", ~L%
PRINT "RELOAD AT H%=", ~H_F%

PRINT "S.ELTF ",~C_F%," ",~P%," ",~L%," ",~H_F%
SAVE "output/ELTF.bin", C_F%, P%, L%

PRINT "F d,";

;DEFFNS(A$)
;N%=LEN(A$)DIV2
;FORI%=0TON%-1
;I%?O%=EVAL("&"+MID$(A$,2*I%+1,2))
;NEXT
;P%=P%+N%
;O%=O%+N%
;=""

\************************************************
\* ELITE<G>
\************************************************

;H%=L%+P%-C%
;O%=W%
C_G%=P%
H_G%=L%+P%-C_A%

\[OPTZ

.SHPPT JSREE51
JSRPROJ
ORAK3+1
BNEnono
LDAK4
CMP#Y*2-2
BCSnono
LDY#2
jsrShpt
ldy#6
ldaK4
ADC#1
jsrShpt
LDA#8
ORAXX1+31
STAXX1+31
LDA#8
JMPLL81+2
PLA
PLA
.nono lda#&F7
andXX1+31
staXX1+31
RTS

.Shpt STA(XX19),Y
iny
iny
STA(XX19),Y
LDAK3
DEY
STA(XX19),Y
ADC#3
BCSnono-2
dey
dey
STA(XX19),Y
rts

.LL5 \2BSQRT Q=SQR(RQ)

LDYR
LDAQ
STAS
LDX#0
STXQ
LDA#8
STAT
.LL6 CPXQ
BCCLL7
BNELL8
CPY#&40
BCCLL7
.LL8 TYA
SBC#&40
TAY
TXA
SBCQ
TAX
.LL7 ROLQ
ASLS
TYA
ROLA
TAY
TXA
ROLA
TAX
ASLS
TYA
ROLA
TAY
TXA
ROLA
TAX
DECT
BNELL6
RTS

.LL28 \BFRDIV R=A*256/Q

CMPQ
BCSLL2
LDX#254
STXR
.LL31 ASLA
BCSLL29
CMPQ
BCCP%+4
SBCQ
ROLR
BCSLL31
RTS
.LL29 SBCQ
SEC
ROLR
BCSLL31
RTS
.LL2 LDA#FF
STAR
RTS

.LL38 \BADD(S)A=R+Q(SA)

EORS
BMILL39
LDAQ
CLC
ADCR
RTS
.LL39 LDAR
SEC
SBCQ

BCCP%+4
CLC
RTS
PHA
LDAS
EOR#128
STAS
PLA
EOR#255
ADC#1
RTS

.LL51 \XX12=XX15.XX16

LDX#0
LDY#0
.ll51 LDAXX15
STAQ
LDAXX16,X
JSRFMLTU
STAT
LDAXX15+1
EORXX16+1,X
STAS
LDAXX15+2

STAQ
LDAXX16+2,X
JSRFMLTU
STAQ
LDAT
STAR
LDAXX15+3

EORXX16+3,X
JSRLL38
STAT
LDAXX15+4
STAQ
LDAXX16+4,X
JSRFMLTU
STAQ
LDAT
STAR
LDAXX15+5
EORXX16+5,X

JSRLL38
STAXX12,Y
LDAS
STAXX12+1,Y
INY
INY
TXA
CLC
ADC#6
TAX
CMP#17
BCCll51
RTS

.LL25 JMPPLANET

.LL9  \ ENTRY

LDATYPE
BMILL25

LDA#31
STAXX4
LDA#32
BITXX1+31
BNEEE28

BPLEE28
ORAXX1+31
AND#&3F
STAXX1+31
LDA#0
LDY#28
STA(INF),Y
LDY#30
STA(INF),Y
JSREE51
LDY#1
LDA#18
STA(XX19),Y
LDY#7
LDA(XX0),Y
LDY#2
STA(XX19),Y

\LDAXX1+32\AND#&7F\STAXX1+32
.EE55 INY
JSRDORND
STA(XX19),Y
CPY#6
BNEEE55
.EE28

LDAXX1+8
.EE49 BPLLL10
.LL14 LDAXX1+31
AND#32
BEQEE51
LDAXX1+31
AND#&F7
STAXX1+31
JMPDOEXP
.EE51

LDA#8
BITXX1+31
BEQLL10-1
EORXX1+31
STAXX1+31
JMPLL155
\LL24

RTS
.LL10

LDAXX1+7
CMP#&C0
BCSLL14
LDAXX1
CMPXX1+6
LDAXX1+1
SBCXX1+7
BCSLL14
LDAXX1+3
CMPXX1+6
LDAXX1+4
SBCXX1+7
BCSLL14

LDY#6
LDA(XX0),Y
TAX
LDA#255
STAXX3,X
STAXX3+1,X

LDAXX1+6
STAT
LDAXX1+7
LSRA
RORT
LSRA
RORT
LSRA
RORT
LSRA
BNELL13
LDAT
RORA
LSRA
LSRA
LSRA
STAXX4

BPLLL17
.LL13 LDY#13
LDA(XX0),Y
CMPXX1+7
BCSLL17
LDA#32
ANDXX1+31
BNELL17
JMPSHPPT
.LL17

LDX#5
.LL15 LDAXX1+21,X
STAXX16,X
LDAXX1+15,X
STAXX16+6,X
LDAXX1+9,X
STAXX16+12,X
DEX
BPLLL15

LDA#197 \NORM
STAQ
LDY#16
.LL21 LDAXX16,Y
ASLA
LDAXX16+1,Y

ROLA
JSRLL28
LDXR
STXXX16,Y
DEY
DEY
BPLLL21

LDX#8
.ll91 LDAXX1,X
STAXX18,X
DEX
BPLll91

LDA#255
STAXX2+15

LDY#12
LDAXX1+31
AND#32
BEQEE29
LDA(XX0),Y
LSRA
LSRA
TAX
LDA#FF
.EE30 STAXX2,X
DEX
BPLEE30
INX
STXXX4
.LL41 JMPLL42
.EE29 LDA(XX0),Y
BEQLL41
STAXX20

\DtProd^XX2

LDY#18
LDA(XX0),Y
TAX
LDAXX18+7
.LL90 TAY
BEQLL91
INX
LSRXX18+4
RORXX18+3
LSRXX18+1
RORXX18
LSRA
RORXX18+6
TAY
BNELL90+3
.LL91 STXXX17
LDAXX18+8

STAXX15+5
LDAXX18
STAXX15
LDAXX18+2
STAXX15+1
LDAXX18+3
STAXX15+2
LDAXX18+5
STAXX15+3
LDAXX18+6
STAXX15+4
JSRLL51
LDAXX12
STAXX18
LDAXX12+1
STAXX18+2
LDAXX12+2

STAXX18+3
LDAXX12+3
STAXX18+5
LDAXX12+4
STAXX18+6
LDAXX12+5
STAXX18+8

LDY#4
LDA(XX0),Y
CLC
ADCXX0
STAV
LDY#17
LDA(XX0),Y
ADCXX0+1
STAV+1
LDY#0

.LL86 LDA(V),Y
STAXX12+1
AND#31
CMPXX4
BCSLL87

TYA
LSRA
LSRA
TAX
LDA#255
STAXX2,X
TYA
ADC#4

TAY
JMPLL88
.LL87 LDAXX12+1
ASLA
STAXX12+3
ASLA
STAXX12+5

INY
LDA(V),Y
STAXX12
INY
LDA(V),Y
STAXX12+2
INY
LDA(V),Y

STAXX12+4
LDXXX17
CPX#4
BCCLL92
.LL143 

\Face offset<<PV

LDAXX18
STAXX15
LDAXX18+2
STAXX15+1
LDAXX18+3
STAXX15+2
LDAXX18+5
STAXX15+3
LDAXX18+6
STAXX15+4
LDAXX18+8
STAXX15+5

JMPLL89
.ovflw LSRXX18
LSRXX18+6
LSRXX18+3
LDX#1
.LL92 LDAXX12
STAXX15
LDAXX12+2
STAXX15+2
LDAXX12+4

.LL93 DEX
BMILL94
LSRXX15
LSRXX15+2
LSRA
DEX
BPLLL93+3

.LL94 STAR
LDAXX12+5
STAS
LDAXX18+6
STAQ
LDAXX18+8
JSRLL38
BCSovflw

STAXX15+4
LDAS
STAXX15+5

LDAXX15
STAR
LDAXX12+1
STAS

LDAXX18
STAQ
LDAXX18+2
JSRLL38
BCSovflw
STAXX15
LDAS
STAXX15+1

LDAXX15+2
STAR
LDAXX12+3
STAS
LDAXX18+3
STAQ
LDAXX18+5

JSRLL38
BCSovflw
STAXX15+2
LDAS
STAXX15+3

.LL89 LDAXX12
STAQ
LDAXX15
JSRFMLTU
STAT
LDAXX12+1

EORXX15+1
STAS
LDAXX12+2
STAQ
LDAXX15+2
JSRFMLTU
STAQ

LDAT
STAR
LDAXX12+3
EORXX15+3
JSRLL38
STAT
LDAXX12+4

STAQ
LDAXX15+4
JSRFMLTU
STAQ
LDAT
STAR
LDAXX15+5

EORXX12+5
JSRLL38
PHA
TYA
LSRA
LSRA
TAX
PLA

BITS
BMIP%+4
LDA#0
STAXX2,X
INY
.LL88 CPYXX20
BCSLL42
JMPLL86

.LL42 \DO nodeX-Ycoords

\TrnspMat
LDYXX16+2
LDXXX16+3
LDAXX16+6
STAXX16+2
LDAXX16+7
STAXX16+3
STYXX16+6
STXXX16+7

LDYXX16+4
LDXXX16+5
LDAXX16+12
STAXX16+4
LDAXX16+13

STAXX16+5
STYXX16+12
STXXX16+13

LDYXX16+10
LDXXX16+11
LDAXX16+14
STAXX16+10
LDAXX16+15

STAXX16+11
STYXX16+14
STXXX16+15

LDY#8
LDA(XX0),Y
STAXX20

LDAXX0
CLC
ADC#20
STAV
LDAXX0+1
ADC#0
STAV+1
LDY#0
STYCNT

.LL48 STYXX17
LDA(V),Y
STAXX15
INY
LDA(V),Y
STAXX15+2
INY

LDA(V),Y
STAXX15+4
INY
LDA(V),Y
STAT
AND#31
CMPXX4
BCCLL49-3
INY
LDA(V),Y
STAP
AND#15
TAX
LDAXX2,X

BNELL49
LDAP
LSRA
LSRA
LSRA
LSRA
TAX
LDAXX2,X
BNELL49
INY
LDA(V),Y
STAP
AND#15
TAX
LDAXX2,X
BNELL49
LDAP
LSRA
LSRA
LSRA
LSRA
TAX
LDAXX2,X
BNELL49
JMPLL50

\"��

.LL49 LDAT
STAXX15+1
ASLA
STAXX15+3
ASLA
STAXX15+5

JSRLL51
LDAXX1+2
STAXX15+2
EORXX12+1
BMILL52
CLC
LDAXX12

ADCXX1
STAXX15
LDAXX1+1
ADC#0
STAXX15+1
JMPLL53

.LL52 LDAXX1
SEC
SBCXX12
STAXX15
LDAXX1+1
SBC#0
STAXX15+1

BCSLL53
EOR#FF
STAXX15+1
LDA#1
SBCXX15
STAXX15

BCCP%+4
INCXX15+1
LDAXX15+2
EOR#128
STAXX15+2

.LL53 LDAXX1+5
STAXX15+5
EORXX12+3
BMILL54
CLC
LDAXX12+2

ADCXX1+3
STAXX15+3
LDAXX1+4
ADC#0
STAXX15+4
JMPLL55

.LL54 LDAXX1+3
SEC
SBCXX12+2
STAXX15+3
LDAXX1+4
SBC#0

STAXX15+4
BCSLL55
EOR#255
STAXX15+4
LDAXX15+3
EOR#255
ADC#1

STAXX15+3
LDAXX15+5
EOR#128
STAXX15+5
BCCLL55
INCXX15+4

.LL55 LDAXX12+5
BMILL56
LDAXX12+4
CLC
ADCXX1+6
STAT

LDAXX1+7
ADC#0
STAU
JMPLL57

.LL61 LDXQ
BEQLL84
LDX#0
.LL63 LSRA
INX
CMPQ
BCSLL63

STXS
JSRLL28
LDXS
LDAR
.LL64 ASLA
ROLU
BMILL84
DEX
BNELL64
STAR
RTS
.LL84 LDA#50
STAR
STAU
RTS

.LL62 LDA#128
SEC
SBCR
STAXX3,X
INX
LDA#0
SBCU
STAXX3,X
JMPLL66

.LL56 LDAXX1+6
SEC
SBCXX12+4
STAT
LDAXX1+7
SBC#0
STAU

BCCLL140
BNELL57
LDAT
CMP#4
BCSLL57
.LL140 LDA#0
STAU

LDA#4
STAT
.LL57 LDAU
ORAXX15+1
ORAXX15+4
BEQLL60
LSRXX15+1
RORXX15
LSRXX15+4
RORXX15+3
LSRU
RORT
JMPLL57

.LL60 LDAT
STAQ
LDAXX15
CMPQ
BCCLL69
JSRLL61
JMPLL65

.LL69 JSRLL28
.LL65 LDXCNT
LDAXX15+2
BMILL62
LDAR

CLC
ADC#128
STAXX3,X
INX
LDAU
ADC#0
STAXX3,X

.LL66 TXA
PHA
LDA#0
STAU
LDAT
STAQ
LDAXX15+3
CMPQ
BCCLL67

JSRLL61
JMPLL68
.LL70 LDA#Y
CLC
ADCR
STAXX3,X
INX

LDA#0
ADCU
STAXX3,X
JMPLL50

.LL67 JSRLL28
.LL68 PLA
TAX
INX
LDAXX15+5
BMILL70
LDA#Y

SEC
SBCR
STAXX3,X
INX
LDA#0
SBCU
STAXX3,X

.LL50 CLC
LDACNT
ADC#4
STACNT
LDAXX17
ADC#6
TAY
BCSLL72

\"��

CMPXX20
BCSLL72
JMPLL48
.LL72 LDAXX1+31
AND#32
BEQEE31
LDAXX1+31
ORA#8
STAXX1+31
JMPDOEXP
.EE31

LDA#8
BITXX1+31
BEQLL74
JSRLL155
LDA#8

.LL74 ORAXX1+31
STAXX1+31

LDY#9
LDA(XX0),Y
STAXX20

LDY#0
STYU
STYXX17
INCU
BITXX1+31
BVCLL170
LDAXX1+31
AND#&BF
STAXX1+31

LDY#6
LDA(XX0),Y
TAY
LDXXX3,Y
STXXX15
INX
BEQLL170
LDXXX3+1,Y
STXXX15+1
INX
BEQLL170
LDXXX3+2,Y
STXXX15+2

LDXXX3+3,Y
STXXX15+3
LDA#0
STAXX15+4
STAXX15+5
STAXX12+1
LDAXX1+6
STAXX12

LDAXX1+2
BPLP%+4
DECXX15+4
JSRLL145
BCSLL170
LDYU

LDAXX15
STA(XX19),Y
INY
LDAXX15+1
STA(XX19),Y
INY
LDAXX15+2
STA(XX19),Y
INY
LDAXX15+3
STA(XX19),Y
INY
STYU
.LL170

 \ Calculate new lines

LDY#3
CLC
LDA(XX0),Y
ADCXX0

STAV
LDY#16
LDA(XX0),Y
ADCXX0+1
STAV+1
LDY#5
LDA(XX0),Y
STAT1
LDYXX17

.LL75 LDA(V),Y
CMPXX4
BCCLL78

INY
LDA(V),Y
INY
STAP
AND#15
TAX
LDAXX2,X
BNELL79
LDAP
LSRA
LSRA
LSRA
LSRA
TAX

\"��

LDAXX2,X
BEQLL78
.LL79 LDA(V),Y

TAX
INY
LDA(V),Y
STAQ
LDAXX3+1,X
STAXX15+1
LDAXX3,X
STAXX15

LDAXX3+2,X
STAXX15+2
LDAXX3+3,X
STAXX15+3
LDXQ
LDAXX3,X

STAXX15+4
LDAXX3+3,X
STAXX12+1
LDAXX3+2,X
STAXX12

LDAXX3+1,X
STAXX15+5
JSRLL147
BCSLL78

.LL80 LDYU
LDAXX15
STA(XX19),Y
INY
LDAXX15+1

STA(XX19),Y
INY
LDAXX15+2
STA(XX19),Y
INY
LDAXX15+3

STA(XX19),Y
INY
STYU
CPYT1
BCSLL81

.LL78 INCXX17
LDYXX17
CPYXX20
BCSLL81
LDY#0
LDAV
ADC#4

\"��

STAV
BCCll81
INCV+1
.ll81 JMPLL75

.LL81 LDAU
LDY#0
STA(XX19),Y

.LL155

\ CLEAR LINEstr

LDY#0
LDA(XX19),Y
STAXX20
CMP#4
BCCLL118-1
INY

.LL27 LDA(XX19),Y
STAXX15
INY
LDA(XX19),Y
STAXX15+1

INY
LDA(XX19),Y
STAXX15+2
INY
LDA(XX19),Y
STAXX15+3

JSRLL30
INY
CPYXX20
BCCLL27
\LL82

RTS
.LL118  \move XX15,XX15+2 to screen-grad.XX12+2

LDAXX15+1
BPLLL119
STAS
JSRLL120  \ X1<0

TXA
CLC
ADCXX15+2
STAXX15+2
TYA
ADCXX15+3
STAXX15+3

LDA#0
STAXX15
STAXX15+1
TAX

.LL119 BEQLL134
STAS
DECS
JSRLL120 \ X1>255

TXA
CLC
ADCXX15+2
STAXX15+2
TYA
ADCXX15+3
STAXX15+3

LDX#FF
STXXX15
INX
STXXX15+1

.LL134 LDAXX15+3
BPLLL135
STAS
LDAXX15+2
STAR   \ Y1<0

JSRLL123
TXA
CLC
ADCXX15
STAXX15
TYA
ADCXX15+1
STAXX15+1

LDA#0
STAXX15+2
STAXX15+3

.LL135 \BNELL139
LDAXX15+2
SEC
SBC#Y*2
STAR     \ Y1>191

LDAXX15+3
SBC#0
STAS
BCCLL136
.LL139 JSRLL123
TXA
CLC
ADCXX15

STAXX15
TYA
ADCXX15+1
STAXX15+1
LDA#Y*2-1
STAXX15+2
LDA#0
STAXX15+3
.LL136 RTS

\ YX=SR*M/256

.LL120 LDAXX15
STAR

\.LL120
JSRLL129
PHA
LDXT
BNELL121
.LL122

LDA#0
TAX
TAY
LSRS
RORR
ASLQ
BCCLL126
.LL125 TXA
CLC

ADCR
TAX
TYA
ADCS
TAY
.LL126 LSRS
RORR
ASLQ
BCSLL125

BNELL126
PLA
BPLLL133
RTS

\ YX=SR*256/M (M=grad.)

.LL123 JSRLL129
PHA
LDXT
BNELL122
.LL121

LDA#255
TAY
ASLA
TAX
.LL130 ASLR
ROLS
LDAS
BCSLL131

CMPQ
BCCLL132
.LL131 SBCQ
STAS
LDAR
SBC#0
STAR
SEC

.LL132 TXA
ROLA
TAX
TYA
ROLA
TAY
BCSLL130
PLA
BMILL128

.LL133 TXA
EOR#FF
\CLC
ADC#1
TAX
TYA
EOR#FF
ADC#0
TAY
.LL128 RTS

.LL129 LDXXX12+2
STXQ
LDAS
BPLLL127
LDA#0
SEC
SBCR
STAR
LDAS
PHA
EOR#255
ADC#0
STAS
PLA
.LL127 EORXX12+3
RTS

.LL145 \CLIP

LDA#0
STASWAP

LDAXX15+5
.LL147 LDX#Y*2-1
ORAXX12+1
BNELL107
CPXXX12

BCCLL107
LDX#0
.LL107 STXXX13
LDAXX15+1
ORAXX15+3
BNELL83

LDA#Y*2-1
CMPXX15+2
BCCLL83

LDAXX13
BNELL108
.LL146 LDAXX15+2

STAXX15+1
LDAXX15+4
STAXX15+2
LDAXX12
STAXX15+3
CLC
RTS

.LL109 SEC
RTS
.LL108 LSRXX13
.LL83

LDAXX13
BPLLL115

LDAXX15+1
ANDXX15+5
BMILL109
LDAXX15+3
ANDXX12+1
BMILL109

LDXXX15+1
DEX
TXA
LDXXX15+5
DEX
STXXX12+2
ORAXX12+2

BPLLL109
LDAXX15+2
CMP#Y*2
LDAXX15+3
SBC#0
STAXX12+2

LDAXX12
CMP#Y*2
LDAXX12+1
SBC#0
ORAXX12+2
BPLLL109

.LL115 TYA
PHA
LDAXX15+4
SEC
SBCXX15
STAXX12+2
LDAXX15+5

SBCXX15+1
STAXX12+3
LDAXX12
SEC
SBCXX15+2
STAXX12+4

LDAXX12+1
SBCXX15+3
STAXX12+5
EORXX12+3
STAS

LDAXX12+5
BPLLL110
LDA#0
SEC
SBCXX12+4
STAXX12+4
LDA#0
SBCXX12+5
STAXX12+5

.LL110 LDAXX12+3
BPLLL111
SEC
LDA#0
SBCXX12+2
STAXX12+2
LDA#0
SBCXX12+3

\GETgrad

.LL111 TAX
BNELL112
LDXXX12+5
BEQLL113
.LL112 LSRA
RORXX12+2

LSRXX12+5
RORXX12+4
JMPLL111
.LL113 STXT
LDAXX12+2

CMPXX12+4
BCCLL114
STAQ
LDAXX12+4
JSRLL28

 \ Use Y/X grad.

JMPLL116
.LL114 LDAXX12+4
STAQ
LDAXX12+2
JSRLL28

 \ Use X/Y grad.

DECT
.LL116 LDAR
STAXX12+2
LDAS
STAXX12+3

LDAXX13
BEQLL138
BPLLLX117
.LL138 JSRLL118

LDAXX13
BPLLL124

.LL117 LDAXX15+1
ORAXX15+3
BNELL137
LDAXX15+2
CMP#Y*2

BCSLL137
.LLX117 LDXXX15
LDAXX15+4
STAXX15
STXXX15+4
LDAXX15+5

LDXXX15+1
STXXX15+5
STAXX15+1
LDXXX15+2
LDAXX12
STAXX15+2

STXXX12
LDAXX12+1
LDXXX15+3
STXXX12+1
STAXX15+3
JSRLL118

DECSWAP

.LL124 PLA
TAY
JMPLL146
.LL137 PLA
TAY
SEC
RTS

F%=P%

;OSCLI("SAVE ELTG "+STR$~W%+" "+STR$~O%+" "+STR$~L%+" "+STR$~H%)

PRINT "ELITE<G>"
PRINT "ASSEMBLE AT W%=", ~C_G%
PRINT "P%=",~P%
PRINT "CODE SIZE=", ~(P%-C_G%)
PRINT "EXECUTE AT L%=", ~L%
PRINT "RELOAD AT H%=", ~H_G%

PRINT "S.ELTG ",~C_G%," ",~P%," ",~L%," ",~H_G%
SAVE "output/ELTG.bin", C_G%, P%, L%

PRINT~C_A%, F%, S%,D%-F%
PRINT"G d."
